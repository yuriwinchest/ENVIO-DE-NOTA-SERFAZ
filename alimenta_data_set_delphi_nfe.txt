unit TNF110_Env_Alimenta_DataSet;

interface

uses
  FMTBcd, SqlExpr, Dialogs, Provider,
  RDprint, DB, DBClient, OleCtrls, SHDocVw, StdCtrls, EGrad, 
  TREdit, Graphics, ExtCtrls, Grids, DBGrids, Mask, Controls, ComCtrls,
  Classes, BDE, Windows, Messages, SysUtils, Forms,
  DBCtrls, Buttons, ToolWin, DBTables, dbxpress, Math,
  IniFiles, ShellAPI, Variants, FileCtrl, StrUtils,
  ENumEd,
  EDBGrid, ACBrNFe, pcnConversao, ACBrUtil, ACBrNFeDANFEClass, ACBrNFeDANFeESCPOS,
   ACBrBase, ACBrDFe, XMLIntf, XMLDoc, zlib, ACBrMail, ACBrNFeDANFeRLClass,
   ACBrDANFCeFortesFr, ACBrPosPrinter, Spin, ACBrDFeReport, ACBrDFeDANFeReport,
   ACBrIntegrador, ACBrDFeException, ACBrDFeUtil, pcnConversaoNFe;

type
  TF_NF110_Env_Alimenta_DataSet = class(TForm)

  function Alimenta_DataSetACBR(var oACBRNFeGeral: TACBrNFe; bVerificaModoEnvio: Boolean = True): string;
  function TipoNF(sTipo:string) : string;
  function Config_XML_Dicionario(sUF:string) : string;
  function IncideFCP(sCFOP: String; sProduto: String): Boolean;

  function DadosNFEACBR(oACBRNFe: TACBRNFe): Boolean;
  function DadosEmitenteACBR(oACBRNFe: TACBRNFe; nQtde_CFOP_5933: Integer): Boolean;
  function DadosDestinatarioACBR(oACBRNFe: TACBRNFe; sTpAmb_B24: String): Boolean;
  function CalculaTotaisIPIDevol(oACBRNFe: TACBRNFe): Double;
  //function DadosItemACBR(oACBRNFe: TACBRNFe; sTpAmb_B24: String): Boolean;

  private
    function VerificaValorSTbyCFOP(pCFOP: String; bDevolucao : Boolean): Boolean;
    function VerificaBCSTbyCFOP(pCFOP: String; bDevolucao : Boolean): Boolean;
    function Rateia_BCIcmsST(pChaveTabela: String; pValorItem: double): double;
    function Rateia_VrIcmsST(pChaveTabela: String; pValorItem: double): double;
    function getTotalItensST(pChaveTabela: String): Integer;
    function getTotalValorST(pChaveTabela: String): Double;

  public

  end;

var
  F_NF110_Env_Alimenta_DataSet: TF_NF110_Env_Alimenta_DataSet;

implementation

uses TNF100_Env_ConfigInicialCompo, TNF010_Dados_Entra, Funcoes,
     TNF150_Env_Trata_Erros, UGrupoICMSUFDestino, UConfigNFE_ACBR, pcnNFeW;

{$R *.dfm}

function TF_NF110_Env_Alimenta_DataSet.getTotalValorST(pChaveTabela: String):Double;
var
   qQry : TSQLQuery;
begin
   //Retorna valor total de Itens com CFOP ST
   try
      qQry := ConsultaBanco('SELECT SUM(VI.VALOR_TOTAL) AS TOTAL FROM VEN_ITENS VI '+
                              ' JOIN NAT_OPER N ON REPLACE(VI.CFOP_ITENS,'','',''.'') = N.CODIGO_NATUREZA '+
                              ' JOIN VEN_NF VN ON VN.CHAVE_TABELA = VI.CHAVE_TABELA '+
                              ' WHERE VI.CHAVE_TABELA = ' + pChaveTabela +
                              '   AND ((N.CLASSIFICACAO LIKE ''%SUBSTITUICAO%'') '+
                              '        OR '+
                              '        (POSITION(''.4'', N.CODIGO_NATUREZA) <> 0) '+
                              '        OR (VN.FINALIDADE = 4) ) '//DEVOLUÇÃO
                              );
      Result := qQry.FieldByName('TOTAL').asFloat;
   finally
      FreeAndNil(qQry);
   end;
end;

function TF_NF110_Env_Alimenta_DataSet.getTotalItensST(pChaveTabela: String):Integer;
var
   qQry : TSQLQuery;
begin
   //Retorna Quantidade de Itens com CFOP ST
   try
      qQry := ConsultaBanco('SELECT COUNT(CHAVE_TABELA) AS QTDE FROM VEN_ITENS VI '+
                              ' JOIN NAT_OPER N ON REPLACE(VI.CFOP_ITENS,'','',''.'') = N.CODIGO_NATUREZA '+
                              ' WHERE VI.CHAVE_TABELA = ' + pChaveTabela +
                              '   AND ((N.CLASSIFICACAO LIKE ''%SUBSTITUICAO%'') '+
                              '        OR '+
                              '        (POSITION(''.4'', N.CODIGO_NATUREZA) <> 0)) ');
      Result := qQry.FieldByName('QTDE').asInteger;
   finally
      FreeAndNil(qQry);
   end;
end;

function TF_NF110_Env_Alimenta_DataSet.Rateia_VrIcmsST(pChaveTabela: String; pValorItem: double): double;
var
  nTotalValorST, nTotalItensST: double;
  nQtdeItensST: double;
begin
  // Calcula valor de ST proporcional ao valor do item

  //Pega total do Valor ST informado na tela
  nTotalValorST := StrToFloat(MostraCampoNumerico('VEN_NF', 'CHAVE_TABELA', pChaveTabela, 'VR_ICMS_SUB', ''));

  //Pega valor total dos itens ST
  nTotalItensST := getTotalValorST(pChaveTabela);

  if nTotalItensST = 0 then
  begin
     Result := 0;
     Exit;
  end;

  //Calcula valor proporcional do item no valor total de itens ST
  //Exemplo: Valor total de itens com ST = 100, valor do item = 10, proporção do item = 10%
  Result := (pValorItem * 100) / nTotalItensST;

  //Usa a proporção para calcular o valor de ST rateado para esse item
  //Exemplo: Valor total ST = 50, proporção do item no total é igual a 10%, então valor ST dele é de 5 reais
  Result := nTotalValorST * (Result / 100);
end;

function TF_NF110_Env_Alimenta_DataSet.Rateia_BCIcmsST(pChaveTabela: String; pValorItem: double): double;
var
  nTotalValorBCST, nTotalItensST: double;
  nQtdeItensST: double;
begin
  // Calcula BC ST proporcional ao valor do item

  //Pega total do Valor ST informado na tela
  nTotalValorBCST := StrToFloat(MostraCampoNumerico('VEN_NF', 'CHAVE_TABELA', pChaveTabela, 'BASE_CALC_ICMS_SUB', ''));

  //Pega valor total dos itens ST
  nTotalItensST := getTotalValorST(pChaveTabela);

  if nTotalItensST = 0 then
  begin
     Result := 0;
     Exit;
  end;

  //Calcula valor proporcional do item no valor total de itens ST
  //Exemplo: Valor total de itens com ST = 100, valor do item = 10, proporção do item = 10%
  Result := (pValorItem * 100) / nTotalItensST;

  //Usa a proporção para calcular o valor de ST rateado para esse item
  //Exemplo: Valor total ST = 50, proporção do item no total é igual a 10%, então valor ST dele é de 5 reais
  Result := nTotalValorBCST * (Result / 100);
end;

function TF_NF110_Env_Alimenta_DataSet.VerificaBCSTbyCFOP(pCFOP : String; bDevolucao : Boolean):Boolean;
begin
   //Verifica se deve informar Base de Cálculo ST para o CFOP informado
   Result := False;
   Result := (Pos('.4',TrocaVirgulaPorPonto(pCFOP)) > 0) //se o segundo dígito é 4
             OR
             bDevolucao; // Devolução pode ter ST

end;

function TF_NF110_Env_Alimenta_DataSet.VerificaValorSTbyCFOP(pCFOP : String; bDevolucao : Boolean):Boolean;
var
   sCFOP : String;
begin
   //Verifica se deve informar Valor ST para o CFOP informado
   sCFOP := '|1.603|2.603|5.603|6.603|5.931|6.931|';
   Result := False;
   Result := (Pos('.4',TrocaVirgulaPorPonto(pCFOP)) > 0) //se o segundo dígito é 4
             OR
             (Pos(TrocaVirgulaPorPonto(pCFOP), SCFOP)>0)//se estiver no array acima
             OR
             bDevolucao; // Devolução pode ter ST

end;

function TF_NF110_Env_Alimenta_DataSet.TipoNF(sTipo:string) : string;
begin
  if      sTipo = 'E' then
    result := '0'
  else if sTipo = 'S' then
    result := '1'
  else
    result := '9'; // pretexto para invalidar
  endif;
end;

function TF_NF110_Env_Alimenta_DataSet.Config_XML_Dicionario(sUF:string) : string;
begin
   if sUF = 'EX' then  // (EX = Exterior)
      Result := ExtractFilePath(ParamStr(0)) + 'NFe\Templates\vm60\Conversor\NFeDataSets_Exportacao.xml'
   else
      Result := ExtractFilePath(ParamStr(0)) + 'NFe\Templates\vm60\Conversor\NFeDataSets.xml';
   endif;
end;

function TF_NF110_Env_Alimenta_DataSet.IncideFCP(sCFOP, sProduto: String): Boolean;
var
   bProduto, bCFOP: Boolean;
begin

   bProduto := MostraCampoString('PRODUTOS_TRIB', 'CODIGO_PRODUTO', sProduto, 'INCIDE_FCP', ' AND CODIGO_FILIAL = ' + IntToStr(iCodigoFilial_NF) ) = '1';
   bCFOP    := MostraCampoString('NAT_OPER', 'CODIGO_NATUREZA', TrocaVirgulaPorPonto(sCFOP), 'INCIDE_FCP', '' ) = '1';

   Result := bProduto or bCFOP;

end;

function TF_NF110_Env_Alimenta_DataSet.Alimenta_DataSetACBR(var oACBRNFeGeral: TACBrNFe; bVerificaModoEnvio: Boolean): string;
var
   sStatServSefaz                         : string;
   sDescrStatServSefaz                    : string;
   sTpAmb_B24                             : string;
   sFormatoFloat                          : string;
   sTmp                                   : string;
   _TMP_COD_BENEFICIO                     : string;   
   sTMP2                                  : string;
   iNumeroDoItem                          : integer;
   iNumeroTotDeItens                      : integer;
   nDelay                                 : integer;
   nTotICMS                               : double;
   nTotFCP, nTotFCPST                     : double;
   nTotIPI, nTotFrete                     : double;
   nTotPIS, nTotCOFINS                    : double;
   nTotII                                 : double;
   nTotalProd                             : double;
   nTotalProd_IBPT                        : double;
   nTotalBase_ICMS                        : double;
   nTotal_ICMS_Deson                      : double;
   nFreteRateado                          : double;
   nVrIpiRateado_Ou_Zerado                : double;
   nVr_Tot_Com_Desconto_Item              : double;
   nVr_a_Reduzir_de_ICMS_Item             : double;
   nVr_BC_ICMS_Bruta_Sem_Reducao_Item     : double;
   nVr_BC_ICMS_Liq_Com_Reducao_Item       : double;
   //nTotDesconDesc_W10                     : double;
   vTotalDescontoItens                    : double;
   bReducaoIcms                           : boolean;
   OK                                     : Boolean;
   sObs                                   : string;
   sOBS_LEGAL_PARA_NF                     : string;
   sNaturezaPlanoPgto                     : string;
   sNomeCli_SeHomologa                    : string;
   sCodTransp                             : string;
   sEAN_I03                               : string;
   sTodos_CodBar_Dif_13Dig                : string;
   sTodos_GTIN13_Invalidos                : string;
   sTodos_CodBar_Brancos                  : string;
   sCodBarraItem                          : string;
   sMensagemCompleta                      : string;
   sPercent_Reduc_BC                      : string;
   nTMP                                   : double;
   sQtdDecimaisValorUnitario              : string;
   nQtde_CFOP_5933                        : integer;
   nQtde_CFOP_DIF_5933                    : integer;
   ////
   //// Var do grupo ITEM
   ////
   sTMP_CFOP_I08                          : string;
   sTMP_cProdANP_LA02                     : string;
   sTMP_UFCons_LA06                       : string;
   sTMP_descANP_LA03                      : string;
   sTMP_pGLP_LA03a                        : string;
   sTMP_pGNn_LA03b                        : string;
   sTMP_pGNi_LA03c                        : string;
   sTMP_vPart_LA03d                       : string;
   sTMP_CODIF_LA04                        : string;
   sTMP_qTemp_LA05                        : string;
   ////
   //// Var do grupo ISSQN
   ////
   nTotISS                                : double;
   nTotalServ, nSomaDesconItem            : double;
   nTot_vServ_W18                         : double;
   ////
   //// Var do grupo ICMS
   ////
   sTMP_modBC_N13                         : string;
   sTMP_orig_N11                          : string;
   sTMP_CST_N12                           : string;
   sTMP_CSOSN_N12a                        : string;
   sTMP_pRedBC_N14                        : string;
   sTMP_vBC_N15                           : string;
   nTot_vProd_W07                         : double;
   sTMP_pICMS_N16                         : string;
   sTMP_vICMS_N17                         : string;
   sTMP_vBCFCP_N17a                       : string;
   sTMP_pFCP_N17b                         : string;
   sTMP_vFCP_N17c                         : string;
   sTMP_modBCST_N18                       : string;
   sTMP_pMVAST_N19                        : string;
   sTMP_pRedBCST_N20                      : string;
   sTMP_vBCST_N21                         : string;
   sTMP_pICMSST_N22                       : string;
   sTMP_vICMSST_N23                       : string;
   sTMP_vBCFCPST_N23a                     : string;
   sTMP_pFCPST_N23b                       : string;
   sTMP_vFCPST_n23d                       : string;
   sTMP_vBCSTRet_N26                      : string;
   sTMP_vICMSSTRet_N27                    : string;
   sTMP_BCFCPSTRet_N27a                   : string;
   sTMP_pFCPSTRet_N27b                    : string;
   sTMP_vFCPSTRet_N27d                    : string;
   sTMP_motDesICMS_N28                    : string;
   sTMP_pCredSN_N29                       : string;
   nAliq_pCredSN_N29                      : double;
   sTMP_vCredICMSSN_N30                   : string;
   nVrBase_Para_CredICMSSN_N30            : double;
   ////
   //// Var do grupo IPI
   ////
   sTMP_clEnq_O02                         : string;
   sTMP_CNPJProd_O03                      : string;
   sTMP_cSelo_O04                         : string;
   sTMP_qSelo_O05                         : string;
   sTMP_cEnq_O06                          : string;
   sTMP_CST_O09                           : string;
   nTMP_vBC_O10                           : double;
   nTMP_pIPI_O13                          : double;
   nTMP_vDesc_I17                         : double;
   nTMP_vIPI_O14                          : double;
   ////
   //// Grupo do PIS / COFINS
   ////
   sTMP_CST_Q06                           : string;
   sTMP_vBC_Q07                           : string;
   sTMP_pPIS_Q08                          : string;
   nTMP_Soma_BC_Reduzida_Pis              : double;
   sTMP_vPIS_Q09                          : string;
   sTMP_qBCProd_Q10                       : string;
   sTMP_vAliqProd_Q11                     : string;
   sTMP_CST_S06                           : string;
   sTMP_vBC_S07                           : string;
   sTMP_pCofins_S08                       : string;
   sTMP_qBCProd_S09                       : string;
   sTMP_vAliqProd_S10                     : string;
   nTMP_Soma_BC_Reduzida_Cofins           : double;
   sTMP_vCOFINS_S11                       : string;
   sBase_CFOP                             : string;
   bUsarAuditorFiscal                     : boolean;
   nSoma_vOutroI17a_WORK                  : double;
   nDif_Diminuir                          : double;
   nDif_Somar                             : double;
   pAliqICMSProd                          : double;
   pAliqFCPProd                           : double;
   nAliqAproxFederal                      : double;
   nAliqAproxEstadual                     : double;
   nAliqAproxMunicipal                    : double;
   nImpostoAproxFederal                   : double;
   nImpostoAproxEstadual                  : double;
   nImpostoAproxMunicipal                 : double;
   sMsgImposto                            : string;
   FGrupoIcmsUFDest                       : TICMSTotComponent;
   oItemIcmsUfDest                        : TICMSUFDestinoCollectionItem;
   bGerarGrupoICMSDest                    : Boolean;
   sOrigem_Produto                        : String;
   vDiferenca                             : Double;
   vValorTotalLiquidoNF                   : Double;
   vValorTotProd                          : Double;
   vValorTotProdDif                       : Double;
   vValorTotProdLocal                     : Double;
   vValorTotFreteDif                      : Double;
   vValorTotIcmsStDif                     : Double;

   sCFOP                                  : String;
   vAliqIcmsInternaDest                   : Double;
   vAliqIcmsInterest                      : Double;
   bGrupoFatInformado                     : Boolean;
   nLiqFatura                             : Double;
   nDuplicata                             : Integer;
   bPossuiParcelas                        : Boolean;

   //Grupo Pagamento
   nValorPlano                            : Double;
   nValorRetISS, nValorRetINSS            : Double;
   nValorRetTec                           : Double;
   //ChequeMoradia
   sNumeroCheque                          : TStringList;
   iIndiceCheques                         : Integer;
   //Variavel de Fuso Horario
   sFuso                                  : String;
   Cor_OLD                                : TColor;
   bOut                                   : Boolean;
   nAliquota_do_mes                       : double;
   nValor_Aproveitamento                  : double;
   sAliquota_Aproveitamento               : String;
   nSoma_Valor_total                      : double;

   function DadosImpostoItem(var oACBRNFe: TACBrNFe; iNumeroItem: Integer): Boolean;
   var
      qProdDI : TSQLQuery;
   begin
      //=========================================================================================
      //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
      //=========================================================================================
      // TAG imposto    I M P O S T O
      //                = = = = = = =
      // Inicio_Tag_Imposto
      //=========================================================================================
      //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
      //=========================================================================================

      if true then
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //     I  C  M  S
         //     =  =  =  =
         // Inicio_Tag_ICMS
         // O grupo ISSQN e mutuamente exclusivo com os grupos ICMS, IPI e II, isto e: se  ISSQN for
         // informado, os grupos ICMS, IPI e II nao serao informados e vice versa
         //
         // (164/N01) Grupo do ICMS da Operacao prï¿½pria e Substituicao Tributaria
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         if true then
         begin

            with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto, F_NF010_Dados_Entra, F_NF150_Env_Trata_Erros do
            begin

               ///////////////////////////////////////////////////////////////////////////////////////////
               // Calculando variaveis necessarias
               ///////////////////////////////////////////////////////////////////////////////////////////

               nFreteRateado := RateiaFrete_BD();
               sPercent_Reduc_BC := FormatFloat('##0.0000' , QRecupVen_Itens.FieldByName('REDUCAO_BASE_CALC_ICMS').AsFloat);
               nTotalProd      := nTotalProd      + vValorTotProd;

               //Define se vai haver DIFAL
               bGerarGrupoICMSDest := False;
               bGerarGrupoICMSDest :=  not((ConfigSemErro('TXT', 'NFE_SIMPLES_SEM_DIFAL') = 'S') and (ConfigSemErro('TXT', 'Nota_Fiscal_Eletronica_CRT') = '1'));
               if bGerarGrupoICMSDest then
               begin
                 bGerarGrupoICMSDest := ( (oACBRNFe.NotasFiscais[0].NFe.Ide.idDest = StrToDestinoOperacao(bOut, '2')) and  //Operação Interestadual
                                          (oACBRNFe.NotasFiscais[0].NFe.Ide.indFinal = StrToConsumidorFinal(bOut,'1')) and //Consumidor Final
                                          (oACBRNFe.NotasFiscais[0].NFe.Dest.indIEDest = StrToindIEDest(bOut, '9')) and  //Não Contribuinte do ICMS
                                          //Gustavo - 02/05/2022 - CFOP 6922 - ENTREGA FUTURA - não destaca ICMS nem DIFAL
                                          (Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString ) <> '6922') and
                                          //Também Itens de Serviço
                                          (Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString ) <> '6933') and
                                          (Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString ) <> '5933')
                                        );
               end;

               if ( (Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString ) <> '5933') and (Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString ) <> '6933'))
                 or
                 ( QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString = Config('TXT','PEDIDO-COD_PROD_REF_SERVICO_GARCON')  )then
               begin

                  if QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat = 0 then
                     sTMP_vBC_N15 := FormatFloat('##0.00', 0)
                  else
                  begin

                     if true then
                     begin

                        nVrIpiRateado_Ou_Zerado := 0;
                        if ( QRecupVen_NF.FieldByName('CRT').AsString = '3')or( QRecupVen_NF.FieldByName('FINALIDADE').AsString = '4')then
                        begin
                           nVrIpiRateado_Ou_Zerado := RateiaIPI_BD();
                        end;

                        nVr_Tot_Com_Desconto_Item          := (vValorTotProd - nTMP_vDesc_I17);
                        nVr_a_Reduzir_de_ICMS_Item         := (nVr_Tot_Com_Desconto_Item ) * (StrToFloat(sPercent_Reduc_BC)/100); // Veja "ID-Coment-06/03/2025-17:53-Mateus"
                        nVr_BC_ICMS_Bruta_Sem_Reducao_Item := nVr_Tot_Com_Desconto_Item + nFreteRateado;
                        nVr_BC_ICMS_Liq_Com_Reducao_Item   := nVr_BC_ICMS_Bruta_Sem_Reducao_Item - nVr_a_Reduzir_de_ICMS_Item;

                        if QRecupVen_Itens.FieldByName('BASE_CALC_ICMS').AsFloat > 0 then
                        begin
                           // Conclui-se que o "Vr da Base de Calculo do ICMS da NF" foi informado explicitamente no
                           // Edit F_NF010_Dados_Entra.C_BaseCalc_ICMS
                           sTMP_vBC_N15 := FormatFloat('##0.00', QRecupVen_Itens.FieldByName('BASE_CALC_ICMS').AsFloat );
                        end
                        else
                        begin
                           sTMP_vBC_N15 := FormatFloat('##0.00', nVr_BC_ICMS_Liq_Com_Reducao_Item);
                        end;

                     end;

                  end;

                  if copy(QRecupVen_Itens.FieldByName('SITUACAO_TRIB').AsString,1,1) <> '' then
                     sTMP_orig_N11        := copy(QRecupVen_Itens.FieldByName('SITUACAO_TRIB').AsString,1,1)
                  else 
                  begin
                     if QRecupVen_Itens.FieldByName('CSOSN_CST_ORIGEM').AsString <> '' then
                        sTMP_orig_N11 := QRecupVen_Itens.FieldByName('CSOSN_CST_ORIGEM').AsString
                     else
                        sTMP_orig_N11        := '0';
                  end;

                  sTMP_modBC_N13       := '3';
                  sTMP_pRedBC_N14      := FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('REDUCAO_BASE_CALC_ICMS').AsFloat);

                  // (* Linha TMP *) pAliqICMSProd := QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat;
                  if ( oACBRNFe.NotasFiscais[0].NFe.Ide.idDest = StrToDestinoOperacao(bOut, '2'))  (* 2 e NF interestadual *)
                     and
                     ( oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe <> StrToFinNFe(bOut, '4'))  (* 4 e NF de devolucao  *)
                     and
                     ( QRecupVen_NF.FieldByName('OPERACAO').AsString <> 'E' )  (* NF de Entrada tem que usar a aliq de ICMS que o usuario informou livremente, esta regra de DIVAL sï¿½ ï¿½ vï¿½lida para vendas *)
                  then
                  begin

                     if MostraCampoString('VEN_NF', 'CHAVE_TABELA', QRecupVen_NF.FieldByName('CHAVE_TABELA').AsString, 'ALIQ_ICMS_ABERTA','') <> 'S' then
                     begin
                        BuscarAliquotasICMSInter(  oACBRNFe.NotasFiscais[0].NFe.Emit.EnderEmit.UF, // UF Origem
                                                   oACBRNFe.NotasFiscais[0].NFe.Dest.EnderDest.UF, // UF Destino
                                                   vAliqIcmsInternaDest,
                                                   vAliqIcmsInterest);

                        pAliqICMSProd := vAliqIcmsInterest;

                        //Para calcular DIFAL, precisa dos dados do ICMS normal
                        if bGerarGrupoICMSDest then
                        begin
                           nVrIpiRateado_Ou_Zerado := 0;
                           if ( QRecupVen_NF.FieldByName('CRT').AsString = '3')or( QRecupVen_NF.FieldByName('FINALIDADE').AsString = '4')then
                           begin
                              nVrIpiRateado_Ou_Zerado := RateiaIPI_BD();
                           end;

                           nVr_Tot_Com_Desconto_Item          := (vValorTotProd - nTMP_vDesc_I17);
                           nVr_a_Reduzir_de_ICMS_Item         := (nVr_Tot_Com_Desconto_Item) * (StrToFloat(sPercent_Reduc_BC)/100); // Veja "ID-Coment-06/03/2025-17:53-Mateus"
                           nVr_BC_ICMS_Bruta_Sem_Reducao_Item := nVr_Tot_Com_Desconto_Item + nFreteRateado;
                           nVr_BC_ICMS_Liq_Com_Reducao_Item   := nVr_BC_ICMS_Bruta_Sem_Reducao_Item - nVr_a_Reduzir_de_ICMS_Item;

                           if QRecupVen_Itens.FieldByName('BASE_CALC_ICMS').AsFloat > 0 then
                           begin
                              // Conclui-se que o "Vr da Base de Calculo do ICMS da NF" foi informado explicitamente no
                              // Edit F_NF010_Dados_Entra.C_BaseCalc_ICMS
                              sTMP_vBC_N15 := FormatFloat('##0.00', QRecupVen_Itens.FieldByName('BASE_CALC_ICMS').AsFloat );
                           end
                           else
                           begin
                              sTMP_vBC_N15 := FormatFloat('##0.00', nVr_BC_ICMS_Liq_Com_Reducao_Item);
                           end;
                        end;
                        
                     end
                     else
                     begin
                        pAliqICMSProd := QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat
                     end;

                  end
                  else 
                  begin
                     pAliqICMSProd := QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat;
                  end;

                  sTMP_pICMS_N16       := FormatFloat('##0.00' , pAliqICMSProd);

                  if ( FileExists(_sPathAplicacao + '\desenvolvimento.sim') )
                  or
                  ( FileExists(_sPathAplicacao + '\desenvolvimento.nao') )
                  then 
                  begin
                     showmessage('Versão em teste, comunique ao suporte - Parei-8929482942');
                  end;

                  if ConfigSemErro('TXT', 'NFE_ARRED_TRUNC_ICMS') <> 'A' then //Se for Truncar (T ou Vazio pois é default, TRUNCA)
                     sTMP_vICMS_N17 := FormatFloat('##0.00' , TruncaDecimais(StrToFloat(sTMP_vBC_N15) *  (StrToFloat(sTMP_pICMS_N16)/100),2))
                  else
                     //Arredonda
                     sTMP_vICMS_N17 := FormatFloat('##0.00' , StrToFloat(sTMP_vBC_N15) *  (StrToFloat(sTMP_pICMS_N16)/100) );
                  {

                  if (StrToFloat(sTMP_vBC_N15) = 0) and (strtofloat(sTMP_vICMS_N17) = 0) then
                     sTMP_pICMS_N16       := FormatFloat('##0.00' , 0);
                  }

                  sTMP_modBCST_N18     := '0';

                  sTMP_pMVAST_N19      := '0.00';

                  sTMP_pRedBCST_N20    := '0.00';

                  //Antes estava rateando o ST em todos os itens, inclusive os não ST, o que é errado. Corrigido para fazer prporcional aos itens ST.
                  //  sTMP_vBCST_N21       := FormatFloat('##0.00' , Rateia_BCIcmsST_BD(      QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsInteger,           QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsFloat * QRecupVen_Itens.FieldByName('QTDE').AsFloat,  QRecupVen_Itens.RecordCount) );
                  if VerificaBCSTbyCFOP(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString, oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '4')) then
                     sTMP_vBCST_N21  := FormatFloat('##0.00' , Rateia_BCIcmsST(QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsString,QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat))
                  else
                     sTMP_vBCST_N21  := '0';
                  endif;

                  if QRecupVen_NF.FieldByName('MVA').asFloat > 0 then
                     sTMP_pMVAST_N19 := QRecupVen_NF.FieldByName('MVA').asString;
                  endif;
                  
                  sTMP_pICMSST_N22     := '0.00';
                  sTMP_vBCSTRet_N26    := '0.00';
                  sTMP_motDesICMS_N28  := '9';


                  // ----------------------------------------------------------------------------------------------
                  // Ini de - Calculo de Permissao de Creditos fiscal de ICMS - SIMPLES NACIONAL
                  // ----------------------------------------------------------------------------------------------

                  //sTMP_pCredSN_N29     := '0.00';   //
                  //sTMP_vCredICMSSN_N30 := '0.00';   // 

                  // Segundo a Delma 62 9992-2557 contadora da Ceramica Progresso (cli da tonac)
                  // Para calcular o credito:
                  //   Devo deixar de fora os campos  FRETE, SEGURO, OUTRAS DESPESAS, IPI
                  //   ICMS SUBST, FCP
                  //   Desta forma vou considerar apenas [VALOR TOT DOS PRODUTOS] - [DESCONTOS]

                  nVrBase_Para_CredICMSSN_N30 := vValorTotProd-nTMP_vDesc_I17;
                  nAliq_pCredSN_N29           := (StrToFloatSemErro( Config('NUM', 'NF_ALIQ_DO_MES_EPP_E_SIMPLES') ) / 100);

                  sTMP_pCredSN_N29     := FloatToStr(nAliq_pCredSN_N29);
                  sTMP_vCredICMSSN_N30 := FloatToStr( nVrBase_Para_CredICMSSN_N30 * nAliq_pCredSN_N29 ); 

                  // Fim de : Calculo de Permissao de Creditos fiscal de ICMS - SIMPLES NACIONAL
                  // ----------------------------------------------------------------------------------------------

                  
                  sTMP_vBCFCPST_N23a   := '0.00';

                  //Pegando dados do FCP

                  //Pega Aliquota FCP
                  pAliqFCPProd := QRecupVen_Itens.FieldByName('ALIQUOTA_FCP').asFloat;
                  //Nï¿½o pegar se for operacao interestadual para consumidor final
                  if not((oACBRNFe.NotasFiscais[0].NFe.Ide.idDest = StrToDestinoOperacao(bOut, '2')) and (oACBRNFe.NotasFiscais[0].NFe.Ide.indFinal = StrToConsumidorFinal(bOut, '1')))then
                  begin

                     if(pAliqFCPProd > 0)then
                     begin
                        sTMP_vBCFCP_N17a  := sTMP_vBC_N15;
                        sTMP_pFCP_N17b    := FormatFloat('##0.00', pAliqFCPProd);
                        sTMP_vFCP_N17c    := FormatFloat('##0.00', (StrToFloat(sTMP_vBC_N15) * (pAliqFCPProd/100)) );
                     end;

                  end;

                  sTMP_pFCPST_N23b     := GetAliquotaFCPEstado(oACBRNFe.NotasFiscais[0].NFe.Dest.EnderDest.UF);
			  
                  if(sTMP_pFCPST_N23b <> '') and (sTMP_vFCP_N17c <> '') and (sTMP_vBCST_N21 <> '')then
                  begin
                     sTMP_vBCFCPST_N23a   := sTMP_vBCST_N21;
                     sTMP_vFCPST_n23d     := FormatFloat('##0.00', (StrToFloat(sTMP_vBCFCPST_N23a) * (StrToFloat(sTMP_pFCPST_N23b)/100)-StrToFloat(sTMP_vFCP_N17c)));
                     if(sTMP_vFCPST_n23d <> '')then
                        if(StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d)) < 0)then
                           sTMP_vFCPST_n23d := '0.00';
                  end;

                  /////////////////////////////////////////////////////////////////////////
                  // Variaveis de totais
                  /////////////////////////////////////////////////////////////////////////

                  // totalizando IPI no bloco de cálculo di IPI agora
                  // nTotIPI         := nTotIPI         + QRecupVen_Itens.FieldByName('ALIQUOTA_IPI').AsFloat/100 * (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro);

                  if UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString) then
                  begin
                     if QRecupVen_NF.FieldByName('NAT_OPERACAO').AsString = '402' then //COMPLEMENTO DE IPI
                        nTotIPI := QRecupVen_NF.FieldByName('VR_IPI').AsFloat;
                  end
                  else
                  begin
                     if(MostraCampoString('NAT_OPERACAO', 'ID', QRecupVen_NF.FieldByName('NAT_OPERACAO').AsString, 'DESCRICAO', '') = 'COMPLEMENTO DE IPI')then
                        nTotIPI := QRecupVen_NF.FieldByName('VR_IPI').AsFloat;
                  end;



                  if ConfigSemErro('TXT', 'NFE_ARRED_TRUNC_IPI') = 'T' then
                     nTotIPI := TruncaDecimais(nTotIPI,2);

                  //Transferido para após CST/CSOSN
                  //nTotICMS        := nTotICMS        + StrToFloat(sTMP_vICMS_N17);
                  //nTotalBase_ICMS := nTotalBase_ICMS + StrToFloat(sTMP_vBC_N15);

                  nTotFrete       := nTotFrete       + nFreteRateado;
                  nTot_vProd_W07  := nTot_vProd_W07  + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;

                  if(nTot_vProd_W07 <> nTotalProd)then
                     nTot_vProd_W07 := nTotalProd;

                  /////////////////////////////////////////////////////////////////////////

                  ///////////////////////////////////////////////////////////////////////////////////////////
                  // Passando valores para o componente ref ICMS
                  ///////////////////////////////////////////////////////////////////////////////////////////


                  if oACBRNFe.NotasFiscais[0].NFe.Emit.CRT = StrToCRT(bOut, '1') then
                  begin

                     if      sTMP_CSOSN_N12a = '101' then
                     begin
                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));
                        ICMS.pCredSN                     := StringToFloat(sTMP_pCredSN_N29);
                        ICMS.vCredICMSSN                 := StringToFloat(sTMP_vCredICMSSN_N30);
                     end
                     else if Contido(sTMP_CSOSN_N12a, '|102|103|300|400|') then
                     begin
                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));
                     end
                     else if sTMP_CSOSN_N12a = '201' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));
                        ICMS.modBCST                     := StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);
                        ICMS.pCredSN                     := StringToFloat(sTMP_pCredSN_N29);
                        ICMS.vCredICMSSN                 := StringToFloat(sTMP_vCredICMSSN_N30);
                        if StringToFloat(sTMP_pMVAST_N19) > 0 then
                           ICMS.pMVAST                   := StringToFloat(sTMP_pMVAST_N19);
					
                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_vBCFCPST_N23a <> '0.00')then
                           begin

                              nTotFCPST                  := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);
						  
                           end;

                        end;

                     end
                     else if Contido(sTMP_CSOSN_N12a, '|202|203|') then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));
                        ICMS.modBCST                     :=  StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);
                        if StringToFloat(sTMP_pMVAST_N19) > 0 then
                           ICMS.pMVAST                   := StringToFloat(sTMP_pMVAST_N19);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_vBCFCPST_N23a <> '0.00')then
                           begin

                              nTotFCPST := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);

                           end;

                        end;

                     end
                     else if sTMP_CSOSN_N12a = '500' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));

                     end
                     else if sTMP_CSOSN_N12a = '900' then
                     begin

                        if StrToFloat(sTMP_pRedBC_N14) > 0 then
                        begin
                           ICMS.pRedBC := StringToFloat(sTMP_pRedBC_N14);
                        end;

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CSOSN                       := StrToCSOSNIcms(bOut, Trim(sTMP_CSOSN_N12a));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);
                        ICMS.modBCST                     :=  StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);
                        ICMS.pCredSN                     := StringToFloat(sTMP_pCredSN_N29);
                        ICMS.vCredICMSSN                 := StringToFloat(sTMP_vCredICMSSN_N30);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_vBCFCPST_N23a <> '0.00')then
                           begin

                              nTotFCPST := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);
                           end;

                        end;

                     end;

                  end
                  else if (oACBRNFe.NotasFiscais[0].NFe.Emit.CRT = StrToCRT(bOut, '2')) or (oACBRNFe.NotasFiscais[0].NFe.Emit.CRT = StrToCRT(bOut, '3'))then
                  begin

                     if sTMP_CST_N12 = '00' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP                    := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);

                           end;

                        end;

                     end
                     else if  sTMP_CST_N12 = '10' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);
                        ICMS.modBCST                     := StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP                    := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.vBCFCP                := StringToFloat(sTMP_vBCFCP_N17a);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);

                           end;

                           if(sTMP_vBCFCPST_N23a <> '0,00')then
                           begin

                              nTotFCPST := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);

                           end;

                        end;

                     end
                     else if  sTMP_CST_N12 = '20' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.pRedBC                      := StringToFloat(sTMP_pRedBC_N14);
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP                    := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.vBCFCP                := StringToFloat(sTMP_vBCFCP_N17a);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);
                           end;

                        end;

                     end
                     else if  sTMP_CST_N12 = '30' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBCST                     :=  StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_vBCFCPST_N23a <> '0,00')then
                           begin

                              nTotFCPST                  := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);

                           end;

                        end;

                     end
                     else if  Contido(sTMP_CST_N12, '|40|41|50|') then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));

                     end
                     else if  sTMP_CST_N12 = '51' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.vBCFCP                := StringToFloat(sTMP_vBCFCP_N17a);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);

                           end;

                        end;

                     end
                     else if  sTMP_CST_N12 = '60' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));

                     end
                     else if  sTMP_CST_N12 = '70' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.pRedBC                      := StringToFloat(sTMP_pRedBC_N14);
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);
                        ICMS.modBCST                     := StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.vBCFCP                := StringToFloat(sTMP_vBCFCP_N17a);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);

                           end;

                           if(sTMP_vBCFCPST_N23a <> '0,00')then
                           begin

                              nTotFCPST := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);

                           end;

                        end;

                     end
                     else if  sTMP_CST_N12 = '90' then
                     begin

                        ICMS.orig                        := StrToOrig(bOut, Trim(sTMP_orig_N11));
                        ICMS.CST                         := StrToCSTICMS(bOut, Trim(sTMP_CST_N12));
                        ICMS.modBC                       := StrTomodBC(bOut, Trim(sTMP_modBC_N13));
                        ICMS.vBC                         := StringToFloat(sTMP_vBC_N15);
                        ICMS.pICMS                       := StringToFloat(sTMP_pICMS_N16);
                        ICMS.vICMS                       := StringToFloat(sTMP_vICMS_N17);
                        ICMS.modBCST                     :=  StrTomodBCST(bOut, Trim(sTMP_modBCST_N18));
                        ICMS.vBCST                       := StringToFloat(sTMP_vBCST_N21);
                        ICMS.pICMSST                     := StringToFloat(sTMP_pICMSST_N22);
                        ICMS.vICMSST                     := StringToFloat(sTMP_vICMSST_N23);

                        if(IncideFCP(QRecupVen_Itens.fieldByName('CFOP_ITENS').AsString, QRecupVen_Itens.fieldByName('CODIGO_PRODUTO').AsString))then
                        begin

                           if(sTMP_pFCP_N17b <> '')then
                           begin

                              nTotFCP := nTotFCP + StrToFloat(sTMP_vFCP_N17c);
                              ICMS.vBCFCP                := StringToFloat(sTMP_vBCFCP_N17a);
                              ICMS.pFCP                  := StringToFloat(sTMP_pFCP_N17b);
                              ICMS.vFCP                  := StringToFloat(sTMP_vFCP_N17c);

                           end;

                           if(sTMP_vBCFCPST_N23a <> '0,00')then
                           begin

                              nTotFCPST := nTotFCPST + StrToFloat(TrocaPontoPorVirgula(sTMP_vFCPST_n23d));
                              ICMS.vBCFCPST              := StringToFloat(sTMP_vBCFCPST_N23a);
                              ICMS.pFCPST                := StringToFloat(sTMP_pFCPST_N23b);
                              ICMS.vFCPST                := StringToFloatDef(sTMP_vFCPST_N23d,0);

                           end;

                        end;

                     end;

                     //Código do Benefício Fiscal
                     if oACBRNFe.NotasFiscais[0].NFe.Emit.CRT <> StrToCRT(bOut, '1') then
                     begin
                           _TMP_COD_BENEFICIO := QRecupVen_Itens.FieldByName('BENEFICIO_FISC').AsString;//Trim(MostraCampoString('PRODUTOS', 'CODIGO_PRODUTO', QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString, 'BENEFICIO_FISC', ''));
                           if (ICMS.CST in [cst20, cst30, cst40, cst41, cst50, cst70]) and
                              (_TMP_COD_BENEFICIO <> '')
                           then
                           begin
                              oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.motDesICMS := StrTomotDesICMS(bOut,'9');
                              oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMSDeson := (vValorTotProd - nTMP_vDesc_I17) *
                                                                                                   //    StringToFloat(sTMP_pICMS_N16)/100;
                                                                                                       (getAliquotaICMS(oACBRNFe.NotasFiscais[0].NFe.Emit.EnderEmit.UF,
                                                                                                                       oACBRNFe.NotasFiscais[0].NFe.Dest.EnderDest.UF)/100); 

                              //Tratando redução da BC                                                                                                                       
                              if (oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMS > 0) then
                                 oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMSDeson := oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMSDeson -
                                                                                                          oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMS;

                              oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Prod.cBenef := _TMP_COD_BENEFICIO;

                              //oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.motDesICMSST
                              //oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto.ICMS.vICMSSTDeson

                              //00, 10, 51, 60 e 90 - não prenche cBENEF
                              //20 e 70 DF816023 - Saída interestadual de produtos para alimentação ou fabricação de ração animal. - Redução de BC do ICMS
                              //        DF816011 - Saída interna de mercadorias que compõem a cesta básica - Redução de BC do ICMS
                              //30 e 40 - DF814106 - Isenção do ICMS - Saídas internas de mercadorias da cesta básica no Programa Fortalecimento às Famílias de Baixa Renda.
                              //41 e 50 e 70 -  DF890000 - Situações não previstas nos Cbenefs anteriores. - cBenef não previsto
                              {if (ICMS.CST = StrToCSTICMS(bOut,'30')) or (ICMS.CST = StrToCSTICMS(bOut,'41')) then
                                 oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Prod.cBenef := 'GO800001'
                              else
                              if (ICMS.CST = StrToCSTICMS(bOut,'30')) or (ICMS.CST = StrToCSTICMS(bOut,'40')) or (ICMS.CST = StrToCSTICMS(bOut,'50')) then
                                 oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Prod.cBenef := 'GO811003'
                              else if (ICMS.CST = StrToCSTICMS(bOut,'20')) or (ICMS.CST = StrToCSTICMS(bOut,'70')) then
                                 oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Prod.cBenef := 'GO821019';    }
                           end;
                    //    end;
                     end;
                  end;

                  //Transferido para cá, para pegar os valores informados corretamente no item de acordo com CST/CSOSN
                  nTotICMS        := nTotICMS        + ICMS.vICMS;
                  nTotalBase_ICMS := nTotalBase_ICMS + ICMS.vBC;
                  nTotal_ICMS_Deson := nTotal_ICMS_Deson + ICMS.vICMSDeson;

               end
               else
               begin

                  nTotISS := nTotISS + (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat * (QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat/100));

                  nTot_vServ_W18  := nTot_vServ_W18 + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;
                  nTotalServ      := nTotalServ + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;
                  nSomaDesconItem := nSomaDesconItem + (QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat - QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat);

                  ICMS.vICMS := 0;

                  // Conclui-se que o CFOP do item 5933 6933 (de Servicos | ISSQN)
                  ISSQN.cMunFG                     := StrToInt(Trim(MostraCampoString('config','SECAO_CAMPO','EMPRESA-CIDADE-CODIGO','CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF))));
                  oACBRNFe.NotasFiscais[0].NFE.Total.ISSQNtot.dCompet := Now;
                  ISSQN.vBC                        := StringToFloatDef(FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat ), 0);
                  ISSQN.vAliq                      := StringToFloatDef(FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat            ), 0);
                  ISSQN.vISSQN                     := StringToFloatDef(FormatFloat('##0.00' , (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat * (QRecupVen_Itens.FieldByName('ALIQUOTA_ICMS').AsFloat/100))), 0);

                  if Length(ConfigSemErro('TXT', 'OS-RAMO_SERVICO')) = 2 then
                     ISSQN.cListServ               := ConfigSemErro('TXT', 'OS-RAMO_SERVICO')+'.01'
                  else
                     ISSQN.cListServ               := ifThen(ConfigSemErro('TXT', 'OS-RAMO_SERVICO') = '', '01.01', ConfigSemErro('TXT', 'OS-RAMO_SERVICO'));

                  ISSQN.indISS                     := StrToindISS(bOut, '1');
                  ISSQN.indIncentivo := StrToindIncentivo(bOut, '2');

               end;

            end;

         end;

         /////////////////////////////////////////////////////////////////////////////////////
         // Fim_Tag_ICMS
         /////////////////////////////////////////////////////////////////////////////////////

         ////////////////////////////////////////////////////////////////////////////////////
         //  DIFAL - PARTILHA DE ICMS entre UFs - convï¿½nio ICMS 93/2015
         ////////////////////////////////////////////////////////////////////////////////////
         oItemIcmsUfDest := FGrupoIcmsUFDest.Items.Add;

         if (bGerarGrupoICMSDest) then
         begin
            if (vAliqIcmsInternaDest = 0) or (vAliqIcmsInterest = 0) then
               BuscarAliquotasICMSInter(  oACBRNFe.NotasFiscais[0].NFe.Emit.EnderEmit.UF, // UF Origem
                                          oACBRNFe.NotasFiscais[0].NFe.Dest.EnderDest.UF, // UF Destino
                                          vAliqIcmsInternaDest,
                                          vAliqIcmsInterest);  

            oItemIcmsUfDest.vBCUFDest := QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;

            // By Mateus 10/07/2025, estava fixo erroneamente em 2.00 o FCP, tem que puxar dos itens de venda
            // oItemIcmsUfDest.pFCPUFDest := 2.00;
            oItemIcmsUfDest.pFCPUFDest := QRecupVen_Itens.FieldByName('ALIQUOTA_FCP').asFloat;


            oItemIcmsUfDest.pICMSUFDest := vAliqIcmsInternaDest; {Aliquota interna da UF Dest - UF do Cliente}

            // 4% ou 7% ou 12%
            if (sTMP_orig_N11[1] in ['1','2','3','8']) then
               oItemIcmsUfDest.pICMSInter := 4
            else
               oItemIcmsUfDest.pICMSInter := vAliqIcmsInterest;

            if (oItemIcmsUfDest.pICMSInter <> 4 )and(oItemIcmsUfDest.pICMSInter <> 7 )and(oItemIcmsUfDest.pICMSInter <> 12)then
            begin
			
               oItemIcmsUfDest.pICMSInter := 12;
               ExibeMensagem
                  (
                   'ERRO INTERNO Alíquota da partilha do ICMS, |'                   +
                   'anote este código MSG-06072016160235 e o nr da NF e fale com '  +
                   'seu suporte técnico. '                                          +
                   'Ou verifique o cadastro de Alíquotas de ICMS Interestadual |'   +
                   'Por enquanto clique OK para prosseguir.'                        ,
                   'ERRO NA PARTILHA DO ICMS'                                       ,
                    Erro
                  );
				 
            end;
			
            oItemIcmsUfDest.CalcularValoresIcms;

            with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto do
            begin

               ICMSUFDest.vBCUFDest                := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vBCUFDest), 0);
               ICMSUFDest.pFCPUFDest               := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.pFCPUFDest), 0);
               ICMSUFDest.pICMSUFDest              := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.pICMSUFDest), 0);
               ICMSUFDest.pICMSInter               := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.pICMSInter), 0);
               ICMSUFDest.pICMSInterPart           := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.pICMSInterPart), 0);
               ICMSUFDest.vFCPUFDest               := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vFCPUFDest), 0);
               ICMSUFDest.vICMSUFDest              := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vICMSUFDest), 0);
               ICMSUFDest.vICMSUFRemet             := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vICMSUFRemet), 0);

               // O correto é ver se tem aliquota de FCP, se tiver entao deve ter tb a BC
               // ICMSUFDest.vBCFCPUFDest          := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vBCUFDest), 0);
               if QRecupVen_Itens.FieldByName('ALIQUOTA_FCP').asFloat > 0 then
                  ICMSUFDest.vBCFCPUFDest := StringToFloatDef(FormatFloat('0.00', oItemIcmsUfDest.vBCUFDest), 0)
               else
                  ICMSUFDest.vBCFCPUFDest := 0;
               endif;               

            end;
			
         end;

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //     I P I
         //     = = =
         // Inicio_Tag_IPI
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         if true then
         begin

            with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto do
            begin

               nTMP_pIPI_O13   := QRecupVen_Itens.FieldByName('ALIQUOTA_IPI').AsFloat;
               sTMP_CST_O09    := Trim(QRecupVen_Itens.FieldByName('CST_IPI_O09').AsString);
		   
               if sTMP_CST_O09 = 'XX' then
                  sTMP_CST_O09 := '';

               if (nTMP_pIPI_O13 > 0  ) or (sTMP_CST_O09  <> '') then    
               begin

                  sTMP_clEnq_O02    := '';
                  sTMP_CNPJProd_O03 := '';
                  sTMP_cSelo_O04    := '';
                  sTMP_qSelo_O05    := '0';
                  sTMP_cEnq_O06     := '999';

                  //A Base de Cálculo do IPI não deve considerar descontos, e também deve considerar Frete, Seguro e Outras Despesas
                  //Base de cálculo IPI = (Valor do produto + Frete + Seguro + Outras Despesas Acessórias)
                  //Fontes: https://facil123.com.br/blog/ipi/
                  //        https://nfe.io/blog/nota-fiscal/o-que-e-ipi/
                  //Antigo:
                  {nTMP              := QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat
                                       + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro; }
                  //Novo:
                  nTMP              := QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat
                                       + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vFrete //RateiaFrete_BD()
                                       + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vSeg //RateiaSeguro_BD()
                                       + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro;


                  nTMP_vBC_O10      := StrToCurr(FormatFloat('##0.00', nTMP));
                  nTMP_vIPI_O14     := nTMP_vBC_O10 * (nTMP_pIPI_O13/100);

                  //Código abaixo desnecessário, pois faz a mesma conta que acima (do código antigo)
                  //if(nTMP_vIPI_O14 <> (QRecupVen_Itens.FieldByName('ALIQUOTA_IPI').AsFloat/100 * (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro)))then
                  //   nTMP_vIPI_O14 :=  QRecupVen_Itens.FieldByName('ALIQUOTA_IPI').AsFloat/100 * (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro);

                  if ConfigSemErro('TXT', 'NFE_ARRED_TRUNC_IPI') = 'T' then
                     nTMP_vIPI_O14 := TruncaDecimais(nTMP_vIPI_O14,2);

                  //-----------------------------------------
                  //-- Manutenção Emergencial MM Máquinas ---
                  //-- Grupo Declaração de Importação -------
                  //-- Valores fixados para emitir nota -----
                  //-- com urgência, dia 25/11/2022  --------
                  //-----------------------------------------

                  if Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)) = '22.889.525/0001-62' then  //MM MAQUINAS
                  begin
                     try
                        qProdDI := ConsultaBanco('SELECT * FROM PRODUTO_DI WHERE CODIGO_PRODUTO = '+QuotedStr(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString));
                        if not qProdDi.isEmpty then
                        begin
                           nTMP := QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat;
                           nTMP_vBC_O10      := StrToCurr(FormatFloat('##0.00', nTMP));
                           nTMP_vIPI_O14     := nTMP_vBC_O10 * (nTMP_pIPI_O13/100);
                        end;
                     finally
                        FreeAndNil(qProdDI);
                     end;
                  end;
                  //------------------------
                  //--FIM MM MAQUINAS
                  //--------------------------

                  //Totalizando IPI
                  //nTotIPI         := nTotIPI         + QRecupVen_Itens.FieldByName('ALIQUOTA_IPI').AsFloat/100 * (QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat + oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].Prod.vOutro);
                  nTotIPI := nTotIPI + nTMP_vIPI_O14;

                  if(oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe <> StrToFinNFe(bOut, '4')) then  //diferente de DEVOLUCAO
                  begin

                     IPI.CNPJProd      := sTMP_CNPJProd_O03;
                     IPI.cSelo         := sTMP_cSelo_O04;
                     IPI.qSelo         := StrToInt(sTMP_qSelo_O05);
                     IPI.cEnq          := sTMP_cEnq_O06;
                     IPI.CST           := StrToCSTIPI(bOut, sTMP_CST_O09);

                     IPI.vBC           := StringToFloatDef(FormatFloat('##0.00' , nTMP_vBC_O10   ), 0);
                     IPI.pIPI          := StringToFloatDef(FormatFloat('##0.00' , nTMP_pIPI_O13  ), 0);
                     IPI.vIPI          := StringToFloatDef(FormatFloat('##0.00' , nTMP_vIPI_O14  ), 0);


                     if UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString) then
                     begin
                        if QRecupVen_NF.FieldByName('NAT_OPERACAO').AsString = '402' then //COMPLEMENTO DE IPI
                           IPI.vIPI := StringToFloatDef(FormatFloat('##0.00' , QRecupVen_NF.FieldByName('VR_IPI').AsFloat), 0);
                     end
                     else
                     begin
                        if(MostraCampoString('NAT_OPERACAO', 'ID', QRecupVen_NF.FieldByName('NAT_OPERACAO').AsString, 'DESCRICAO', '') = 'COMPLEMENTO DE IPI')then
                           IPI.vIPI := StringToFloatDef(FormatFloat('##0.00' , QRecupVen_NF.FieldByName('VR_IPI').AsFloat), 0);
                     end;

                  end
                  else
                  begin
                     //Comentário a pedido do Mateus: 21/06/2023
                     //"CFOP 1,202 de devolucao nao deve ter DEV DE IPI quando o emitente nao é industria"
                     //Se não é indústria, e CFOP é de Entrada de Devolução, não tem IPI
                     if (not ((ConfigSemErro('TXT', 'Empresa-Industria') = 'S') and (ConfigSemErro('TXT', 'Empresa-IPIVenda') = 'S'))) and
                        (CFOPdeEntrada(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) and CFOPdeDevolucao(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString))
                     then
                     begin
                        oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].pDevol     := 0;
                        oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].vIPIDevol  := 0;
                     end
                     else
                     begin
                        oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].pDevol     := 100;// StringToFloatDef(FormatFloat('##0.00' , nTMP_pIPI_O13  ), 0);
                        oACBRNFe.NotasFiscais[0].NFe.Det.Items[iNumeroItem].vIPIDevol  := StringToFloatDef(FormatFloat('##0.00' , nTMP_vIPI_O14  ), 0);
                     end;

                  end;

               end;

            end;

         end;


         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //     II - Imposto sobre Importação
         //     = = = = = ==  = == =
         // Inicio_Tag_II
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================

         //-----------------------------------------
         //-- Manutenção Emergencial MM Máquinas ---
         //-- Grupo Declaração de Importação -------
         //-- Valores fixados para emitir nota -----
         //-- com urgência, dia 25/11/2022  --------
         //-----------------------------------------

         if Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)) = '22.889.525/0001-62' then  //MM MAQUINAS
         begin
            try
               qProdDI := ConsultaBanco('SELECT * FROM PRODUTO_DI WHERE CODIGO_PRODUTO = '+QuotedStr(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString));
               if not qProdDi.isEmpty then
               begin
                  with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto do
                  begin
                     II.vBc := qProdDI.FieldByName('vBc').asFloat;
                     II.vDespAdu := qProdDI.FieldByName('vDespAdu').asFloat;
                     II.vII := qProdDI.FieldByName('vII').asFloat;
                     II.vIOF := qProdDI.FieldByName('vIOF').asFloat;

                     nTotII := nTotII + II.vII; //soma para totais
                  end;
               end;
            finally
               FreeAndNil(qProdDI);
            end;
         end;
         //------------------------
         //--FIM MM MAQUINAS
         //--------------------------




         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //     P I S  / C O F I N S
         //     = = = = = ==  = == =
         // Inicio_Tag_PisCofins
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         if true then
         begin

            with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem].Imposto do
            begin

               sTMP_CST_Q06       := QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString;

               if QRecupVen_Itens.FieldByName('VR_BC_PIS_Q07').AsFloat > 0 then
               begin
                 // Conclui-se que o usuario informou explicitamente uma Base de Calc do PIS Reduzida
                  sTMP_vBC_Q07              := TrocaVirgulaPorPonto(FormatFloat('##0.00' , ArredondaValor(QRecupVen_Itens.FieldByName('VR_BC_PIS_Q07').AsFloat,2)));
                  nTMP_Soma_BC_Reduzida_Pis := nTMP_Soma_BC_Reduzida_Pis + QRecupVen_Itens.FieldByName('VR_BC_PIS_Q07').AsFloat;
               end
               else begin
                  sTMP_vBC_Q07  := TrocaVirgulaPorPonto(FormatFloat('##0.00' , ArredondaValor(QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat,2)));
               end;

               sTMP_pPIS_Q08      := TrocaVirgulaPorPonto(FormatFloat('##0.00' , ArredondaValor(QRecupVen_Itens.FieldByName('ALIQ_PIS'                ).AsFloat,2)));
               sTMP_vPIS_Q09      := TrocaVirgulaPorPonto(FormatFloat('##0.00',  ArredondaValor(QRecupVen_Itens.FieldByName('VR_PIS_Q09'              ).AsFloat,2)));
               sTMP_qBCProd_Q10   := '0';
               sTMP_vAliqProd_Q11 := '0';
               sTMP_CST_S06       := QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString;

               if QRecupVen_Itens.FieldByName('VR_BC_COFINS_S08').AsFloat > 0 then
               begin
                  // Conclui-se que o usuario informou explicitamente uma Base de Calc do COFINS Reduzida
                  sTMP_vBC_S07                 := TrocaVirgulaPorPonto(FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('VR_BC_COFINS_S08').AsFloat ));
                  nTMP_Soma_BC_Reduzida_Cofins := nTMP_Soma_BC_Reduzida_Cofins + QRecupVen_Itens.FieldByName('VR_BC_COFINS_S08').AsFloat;
               end
               else
               begin
                  sTMP_vBC_S07    := TrocaVirgulaPorPonto(FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat ));
               end;

               sTMP_pCofins_S08   := TrocaVirgulaPorPonto(FormatFloat('##0.00' , QRecupVen_Itens.FieldByName('ALIQ_COFINS'             ).AsFloat ));
               sTMP_qBCProd_S09   := '0';
               sTMP_vAliqProd_S10 := '0';
               sTMP_vCOFINS_S11   := TrocaVirgulaPorPonto(FormatFloat('##0.00',ArredondaValor(QRecupVen_Itens.FieldByName('VR_COFINS_S11').AsFloat,2)));

            

               if contido(QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString, '|01|02|') then
               begin
			
                  // PIS
                  PIS.CST  := StrToCSTPIS(bOut, sTMP_CST_Q06);
                  PIS.vBC  := StringToFloatDef(sTMP_vBC_Q07, 0);
                  PIS.pPIS := StringToFloatDef(sTMP_pPIS_Q08, 0);
                  PIS.vPIS := StringToFloatDef(sTMP_vPIS_Q09, 0);

                  // COFINS

                  COFINS.CST     := StrToCSTCOFINS(bOut, sTMP_CST_S06);
                  COFINS.vBC     := StringToFloatDef(sTMP_vBC_S07, 0);
                  COFINS.pCOFINS := StringToFloatDef(sTMP_pCofins_S08, 0);
                  COFINS.vCOFINS := StringToFloatDef(sTMP_vCOFINS_S11, 0);
				
               end
               else if contido(QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString, '|03|') then
               begin
				 
                  // PIS
                  PIS.CST        := StrToCSTPIS(bOut, sTMP_CST_Q06);
                  PIS.qBCProd    := StringToFloatDef(sTMP_qBCProd_Q10, 0);
                  PIS.vAliqProd  := StringToFloatDef(sTMP_vAliqProd_Q11, 0);
                  PIS.vPIS       := StringToFloatDef(sTMP_vPIS_Q09, 0);

                  // COFINS
                  COFINS.CST        := StrToCSTCOFINS(bOut, sTMP_CST_S06);
                  COFINS.qBCProd    := StringToFloatDef(sTMP_qBCProd_S09, 0);
                  COFINS.vAliqProd  := StringToFloatDef(sTMP_vAliqProd_S10, 0);
                  COFINS.vCOFINS    := StringToFloatDef(sTMP_vCOFINS_S11, 0);

               end
               else if contido(QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString, '|04|06|07|08|09|') then
               begin
			
                  // PIS
                  PIS.CST  := StrToCSTPIS(bOut, sTMP_CST_Q06);

                  // COFINS
                  COFINS.CST     := StrToCSTCOFINS(bOut, sTMP_CST_S06);
				 
               end
               else if contido(QRecupVen_Itens.FieldByName('CST_PIS_COFINS').AsString, '|49|50|51|52|53|54|55|56|60|61|62|63|64|65|66|67|70|71|72|73|74|75|98|99|') then
               begin
			
                  // PIS em percentual:
                  PIS.CST  := StrToCSTPIS(bOut, sTMP_CST_Q06);
                  PIS.vBC  := StringToFloatDef(sTMP_vBC_Q07, 0);
                  PIS.pPIS := StringToFloatDef(sTMP_pPIS_Q08, 0);
                  PIS.vPIS := StringToFloatDef(sTMP_vPIS_Q09, 0);

                  //COFINS em percentual:
                  COFINS.CST     := StrToCSTCOFINS(bOut, sTMP_CST_S06);
                  COFINS.vBC     := StringToFloatDef(sTMP_vBC_S07, 0);
                  COFINS.pCOFINS := StringToFloatDef(sTMP_pCofins_S08, 0);
                  COFINS.vCOFINS := StringToFloatDef(sTMP_vCOFINS_S11, 0);

               end;

               //Gustavo Espíndola - 28/01/2021 - Conversado com o Mateus - Quando não houver alíquota e valor, zera base de cálculo
               if (PIS.pPIS = 0) and (pis.vPIS = 0) then
                  PIS.vBC := 0;
               if (COFINS.pCOFINS = 0) and (COFINS.vCOFINS = 0) then
                  COFINS.vBC := 0;
                  
               nTotPIS := nTotPIS +  PIS.vPIS;
               nTotCOFINS := nTotCOFINS +  COFINS.vCOFINS;
            end;


         end;

      end;
       /////////////////////////////////////////////////////////////////////////
       // Fim_Tag_Imposto
       /////////////////////////////////////////////////////////////////////////
   end;

   function DadosInformacoesAdic(var oACBRNFe: TACBrNFe; iNumeroItem: Integer): Boolean;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.Det[iNumeroItem], F_NF010_Dados_Entra, F_NF150_Env_Trata_Erros do
      begin

         /////////////////////////////////////////////////////////////////////////
         // Informacoes adicionais do produto
         /////////////////////////////////////////////////////////////////////////

         //infAdProd_V01 - Informacoes adicionais do produto
         infAdProd := QRecupVen_Itens.FieldByName('INFO_COMPLE').asString;         
         //        infAdProd := ' DE REPARO E MANUTENÇÃO NA COZINHA PARA SUBSTITUIÇÃO DE PARTO DO REVESTIMENTO DANIFICADO E SUBSTITUIÇÃO DAS TELAS DE PROTEÇÃO DANIFICADAS DAS JANELAS.';
         {         infAdProd := '1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 '+
                               '1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 '+
                               '1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 '+
                               '1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 1234567890123456789012345678901234567890 12345678';
         }
         //-------------------

         if QRecupVen_Itens.FieldByName('REDUCAO_BASE_CALC_ICMS').AsFloat > 0 then
            bReducaoIcms := true;

         /////////////////////////////////////////////////////////////////////////
         // CHEQUE MORADIA    (ITENS)  (Transferencia de Credito)               //
         /////////////////////////////////////////////////////////////////////////

         //Se o CFOP for (5601,5601 ou 6949)
         //Se for finNFE = 3 (Ajuste)
         //Se Natureza de Operacao for TRANSFERENCIA DE Credito DE CHEQUE MORADIA
         if((oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '3')) and (
            Trim(IntToStr(QRecupVen_NF.FieldByName('NAT_OPERACAO').AsInteger)) = iif(UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString),'240','2'))
             and (Contido(Prod.CFOP, '|5601|5602|6949|')))then
         begin

            //a)- Codigo do Produto: GO90999004 (Obrigatoriamente) (Pronto)
            Prod.cProd := 'GO90999004';
            //b)- DESCRICAO DO PRODUTO OU SERVICO: a expressao TRANSFERENCIA DE Credito DE CHEQUE MORADIA (Pronto)
            Prod.xProd := 'TRANSFERENCIA DE Credito DE CHEQUE MORADIA';
            //c)- NCM: o Codigo "00" (Pronto)
            Prod.NCM := '00';
            //d)- CFOP: o Codigo 5.601 ou 5.602 tratando-se de TRANSFERENCIA de Credito para estabelecimento (Pronto)
            //   de outra empresa ou TRANSFERENCIA de Credito para estabelecimento da propria empresa,
            //   respectivamente, localizados em Goias. Caso o destinatario (com inscricao de substituto
            //   tributario em Goias) do Credito seja estabelecido em outra Unidade da Federacao, utilizar
            //   CFOP 6.949 e Outras Saidas;
            //e)- UNIDADE COMERCIAL: a unidade "un" (Pronto)
            //f)- QUANTIDADE COMERCIAL: 1,00 (Pronto)
            //g)- VALOR UNITaRIO DE COMERCIALIZAcaO: 0 (zero) (Fazer)
            Prod.vUnCom := 0;
            //h)- UNIDADE TRIBUTAVEL: a unidade ï¿½unï¿½ (Pronto)
            //i)- QUANTIDADE TRIBUTAVEL: 1,00 (Pronto)
            //j)- VALOR UNITARIO TRIBUTAVEL: 0 (zero) (Fazer)
            Prod.vUnTrib := 0;
            //k)- VALOR TOTAL BRUTO: o valor do Credito em TRANSFERENCIA
            //l)- IndTot : Indicar que o valor do Item (vProd) compoe o valor total da NF-e (opcao com Codigo 1); (Pronto)

            //ICMS, nos campos:
            //a)- REGIME: Tributacao Normal/Simples Nacional, conforme o caso (Pronto)
            //b)- SITUAïCAO TRIBUTARIA: se contribuinte emitente for do regime normal de apuracao,
            //    utilizar o Codigo "90 - Outras". Para contribuinte optante pelo Simples Nacional,
            //    utilizar Codigo de situacao tributaria "900 - Outros", informando no campo ICMS, o valor do Credito em TRANSFERENCIA;
            //c)- ORIGEM: 0 - Nacional (Pronto)
            //d)- MODALIDADE DE DETERMINACAO DA BASE DE CALCULO: Valor da Operacao (Valor 3)
            Imposto.ICMS.modBC := StrTomodBC(bOut, '3');
            //e)- % REDUï¿½ï¿½O DA BC ICMS: deixar em branco (Fazer)
            Imposto.ICMS.pRedBC := 0;
            //f)- BC ICMS: 0 (zero) (Fazer)
            Imposto.ICMS.vBC := 0;
            //g)- ALiQUOTA DO ICMS: 0 (Fazer)
            Imposto.ICMS.pICMS := 0;
            //h)- ICMS: o valor do Credito em TRANSFERENCIA (Fazer)
            Imposto.ICMS.vICMS := Prod.vProd;

            //Pis Cofins
            Imposto.PIS.CST := StrToCSTPIS(bOut, '99');
            Imposto.PIS.vBC := 0;
            Imposto.PIS.pPIS := 0;
            Imposto.PIS.vPIS := 0;
            Imposto.COFINS.CST := StrToCSTCOFINS(bOut, '99');
            Imposto.COFINS.vBC := 0;
            Imposto.COFINS.pCOFINS := 0;
            Imposto.COFINS.vCOFINS := 0;

            //Consumidor Final = 0
            oACBRNFe.NotasFiscais[0].NFe.Ide.indFinal := StrToConsumidorFinal(bOut, '0');

         end;

         /////////////////////////////////////////////////////////////////////////
         // CHEQUE MORADIA    ***FIM***   (Transferencia de Credito)            //
         /////////////////////////////////////////////////////////////////////////

      end;

   end;

   function DadosItemACBR(var oACBRNFe: TACBRNFe;sTpAmb_B24: String): Boolean;
   var
      qProdDI : TSQLQuery;
   begin

      //x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/
      //()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()
      //x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/
      //
      // Itens      I T E N S
      //            = = = = =
      //
      //x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/
      //()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()-()
      //x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/x%x/

      ///////////////////////////////////////////
      //Gustavo Espíndola - 21/01/2021 - Número Máximos de Decimais no Valor Unitário do Item segundo SEFAZ
      //  Não será mais observada a configuração "PEDIDO-FORMATOVALORUNITARIO" nem fixado em 6 (tela de NFe e Pedidos)
      //  nem em 4 (fixado aqui).
      //  Agora o número de decimais do valor unitário seguirá o manual da sefaz, com máximo 10 decimais.

      //      sQtdDecimaisValorUnitario := ConfigSemErro('TXT', 'PEDIDO-FORMATOVALORUNITARIO');
      //      if(sQtdDecimaisValorUnitario= '')then
      //        sQtdDecimaisValorUnitario:= '4';
      
      sQtdDecimaisValorUnitario:= '10';
      //showmessage('vai configurar acbr');
      (*
      oACBRNFe.DANFE.CasasDecimais.Formato := tdetInteger;   // ou  ACBrNFe1.DANFE.CasasDecimais.Formato := 0;
      oACBRNFe.DANFE.CasasDecimais.qCom    := 2;
      oACBRNFe.DANFE.CasasDecimais.vUnCom  := 2;
      *)

      (*
      ACBrNFe1.DANFE.CasasDecimais.Formato := tdetMascara;   // ou  ACBrNFe1.DANFE.CasasDecimais.Formato := 1;
      ACBrNFe1.DANFE.CasasDecimais._Mask_qCom   := ###,###,###,##0.0000
      ACBrNFe1.DANFE.CasasDecimais._Mask_vUnCom := ###,###,###,##0.00000000
      *)



      //FIM Gustavo Espíndola - 21/01/2021
      ///////////////////////////////////////////
      
      vDiferenca           := 0;
      vValorTotProdLocal   := 0;
      nTotalProd           := 0;
      nTotalProd_IBPT      := 0;
      vValorTotProdDif     := 0;
      vValorTotFreteDif    := 0;
      vValorTotIcmsStDif   := 0;
      vValorTotalLiquidoNF := QRecupVen_Basic.FieldByName('VR_TOTAL_LIQUIDO').AsFloat;
      vTotalDescontoItens  := 0;

      // Acha diferenï¿½a
      while not QRecupVen_Itens.eof do
      begin

		   nTotalProd      := nTotalProd      + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;
		   nTotalProd_IBPT := nTotalProd_IBPT + QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat;

		   nTMP_vDesc_I17 := (QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat - QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat);
		   nTMP_vDesc_I17 := ArredondaValor(nTMP_vDesc_I17,2);
		   vTotalDescontoItens := vTotalDescontoItens + nTMP_vDesc_I17;

         if ((Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) <> '5933' ) and (Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) <> '6933' )) then
			   vValorTotProdLocal := vValorTotProdLocal + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;

         QRecupVen_Itens.Next;

      end; {while}
	   // Achar Diferenï¿½a

	   nTotFrete := QRecupVen_Basic.FieldByName('FRETE').AsFloat;
	   vDiferenca := (vValorTotalLiquidoNF - (QRecupVen_NF.FieldByName('VR_IPI').asFloat) - ((nTotalProd - vTotalDescontoItens) + nTotFrete));

      nTot_vProd_W07       := 0;
      nTotalProd           := 0;
      nTotalBase_ICMS      := 0;
      nTotal_ICMS_Deson    := 0;
      nTotICMS             := 0;
      nTotIPI              := 0;
      nTotPIS              := 0;
      nTotCOFINS           := 0;
      nTotII               := 0;
      nTotFrete            := 0;
      vTotalDescontoItens  := 0;

	   // incluir os itens da nota

      iNumeroDoItem := 0;
      QRecupVen_Itens.First;

      while not QRecupVen_Itens.Eof do
      begin

         with oACBRNFe.NotasFiscais[0].NFe.Det.New, F_NF010_Dados_Entra, F_NF150_Env_Trata_Erros  do
         begin

            iNumeroDoItem := iNumeroDoItem + 1; // (99/H02) Numero do Item, 1 ate 990
            Prod.nItem := iNumeroDoItem;

            (* 08/01/2015 Gerar cod completo sem copy evitando dar erro no SPED *)
            sTMP := copy(Trim(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString),1,12);
            Prod.cProd := sTMP;

            if MostraCampoString('PRODUTOS', 'CODIGO', QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString, 'ENVIAR_COD_BAR_SEFAZ', '') = 'S' then
               sEAN_I03 := Alltrim(QRecupVen_Itens.FieldByName('CODIGO_BARRA').AsString)
            else
               sEAN_I03 := 'SEM GTIN';

            if Config('TXT','NFE_NUNCA_ENVIAR_COD_BARRAS') = 'S' then
               sEAN_I03 := 'SEM GTIN';

            if copy(sEAN_I03,1,1) = '2' then  // obs: '2' refere-se a produtos PESAVEIS
               sEAN_I03 := 'SEM GTIN';

            sTMP := Trim(sEAN_I03);
            Prod.cEAN := sTmp;

            sTMP := Normais('xProd_I04', Trim(copy(MostraCampoString('PRODUTOS', 'CODIGO' , QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString , 'NOME'           , ''),1,120)) );
            Prod.xProd := sTmp;

            //-----------------------------------------
            //-- Manutenção Emergencial MM Máquinas ---
            //-- Grupo Declaração de Importação -------
            //-- Valores fixados para emitir nota -----
            //-- com urgência, dia 25/11/2022  --------
            //-----------------------------------------
            
            if Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)) = '22.889.525/0001-62' then  //MM MAQUINAS
            begin
               try
                  qProdDI := ConsultaBanco('SELECT * FROM PRODUTO_DI WHERE CODIGO_PRODUTO = '+QuotedStr(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString));
                  if not qProdDi.isEmpty then
                  begin
                     with Prod.DI.New do
                     begin
                       nDi         := qProdDI.FieldByName('nDi').asString;
                       dDi         := qProdDI.FieldByName('dDi').asDateTime;
                       xLocDesemb  := qProdDI.FieldByName('xLocDesemb').asString;
                       UFDesemb    := qProdDI.FieldByName('UFDesemb').asString;
                       dDesemb     := qProdDI.FieldByName('dDesemb').asDateTime;

                       tpViaTransp :=  StrToTipoViaTransp(bOut,qProdDI.FieldByName('tpViaTransp').asString);
                       tpIntermedio := StrToTipoIntermedio(bOut,qProdDI.FieldByName('tpIntermedio').asString);
                       cExportador := qProdDI.FieldByName('cExportador').asString;

                       vAFRMM := qProdDI.FieldByName('vAFRMM').asFloat;

                       CNPJ := qProdDI.FieldByName('CNPJ').asString;
                       UFTerceiro := qProdDI.FieldByName('UFTerceiro').asString;

                       with adi.New do
                       begin
                         nAdicao     := qProdDI.FieldByName('nAdicao').asInteger;
                         nSeqAdi     := qProdDI.FieldByName('nSeqAdi').asInteger;
                         cFabricante := qProdDI.FieldByName('cFabricante').asString; 
                         //vDescDI     := 0;
                         //nDraw       := '';
                       end;      
                     end;
                  end;
               finally
                  FreeAndNil(qProdDI);
               end;
            end;
            //------------------------
            //--FIM MM MAQUINAS
            //--------------------------







            if (( Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) = '5933' )or(Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) = '6933' ))
            or
            (
               ( QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString = Config('TXT','PEDIDO-COD_PROD_REF_SERVICO_GARCON')  )
               and
               ( Config('TXT','EMPRESA-UF') = 'DF'                                                            )
            )then
               sTMP := '00000000'
            else
            begin
               sTMP := Trim(QRecupVen_Itens.FieldByName('NCM').AsString);
            end;

            sTMP := Trim(QRecupVen_Itens.FieldByName('NCM').AsString);
            Prod.NCM := sTMP;

            sTMP_CST_N12         := copy(Trim(QRecupVen_Itens.FieldByName('SITUACAO_TRIB').AsString),2,2);
            sTMP_CSOSN_N12a      := Trim(QRecupVen_Itens.FieldByName('CSOSN').AsString);

            //Calculando valor ST corretamente somente pelos Itens ST
            if VerificaValorSTbyCFOP(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString, oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '4')) then
               sTMP_vICMSST_N23 := FormatFloat('##0.00' , Rateia_VrIcmsST(QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsString, QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat))
            else
               sTMP_vICMSST_N23 := '0';

            vValorTotIcmsStDif   := vValorTotIcmsStDif + strtofloat(sTMP_vICMSST_N23);//FormatFloat('##0.00', Rateia_VrIcmsST_BD(QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsInteger, QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsFloat * QRecupVen_Itens.FieldByName('QTDE').AsFloat,  QRecupVen_Itens.RecordCount)));
            sTMP_vICMSSTRet_N27  := '0.00';
            sTMP_CFOP_I08        := Retorna_So_Numeros( FormatFloat('#.000', QRecupVen_Itens.FieldByName('CFOP_ITENS').AsFloat));

            if true then
            begin

               sTMP_CFOP_I08 := Retorna_So_Numeros( QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString );
               if (
                     Contido
                     ( sTMP_CFOP_I08,
                       (* Saida/Entrada de combustï¿½vel ou ï¿½leo lubrificante, ï¿½ muito comum OLEO LUBRIFICANTE EM AUTO PEï¿½AS *)
                       '|1650|1651|1652|1653|1658|1659|1660|1661|1662|1663|1664'  +
                       '|2650|2651|2652|2653|2658|2659|2660|2661|2662|2663|2664'  +
                       '|3650|3651|3652|3653'                                     +
                       '|5650|5651|5652|5653|5654|5655|5656|5657'                 +
                       '|5658|5659|5660|5661|5662|5663|5664|5665|5666'            +
                       '|6650|6651|6652|6653|6654|6655|6656|6657|6658'            +
                       '|6659|6660|6661|6662|6663|6664|6665|6666'                 +
                       '|7650|7651|7654|'
                     )
                  or
                     (
                        Retorna_Zero_QuandoVazio(MostraCampoString('VEN_NF', 'CHAVE_TABELA', QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsString, 'VR_ICMS_SUB'       , '')) <> '0'
                     )
                  or
                     (
                        Contido(sTMP_CST_N12   , '|10|30|60|70|90|'     )
                     )
                  or
                     (
                        Contido(sTMP_CSOSN_N12a, '|201|202|203|500|900|')
                     )
                  )
               then
               begin

                  if (sTMP_CST_N12   = '90'  )
                      or
                      (sTMP_CSOSN_N12a = '900')then
                  begin
                     // Nao precisa de CEST para CST 90 ou CSOSN 900 quando o campo vICMSST
                     // for 0 (zero), no entanto nao tenho certeza sobre o campo sTMP_vICMSSTRet_N27,
                     // pois nao sei
                     // bem a diferenca entre sTMP_vICMSST_N23 e sTMP_vICMSSTRet_N27
                     // entao vou colocar os 2 campos nesta condicao por precaucao
                     if ( strToFloat(TrocaPontoPorVirgula(sTMP_vICMSSTRet_N27)) > 0 ) or( strToFloat(TrocaPontoPorVirgula(sTMP_vICMSST_N23   )) > 0 ) then
                     begin
                         Prod.CEST := '2400100';
                     end;

                  end
                  else
                  begin
                     Prod.CEST := '2400100';
                  end;

               end;

            end;

            Prod.CFOP := sTMP_CFOP_I08;

            //////////////////////////////////////////////////////////////////////////////
            (* Criando grupo de combustivel/lubrificante/derivados *)
            //////////////////////////////////////////////////////////////////////////////

            // obs: Ideal mesmo sereia inserir todos esses CFOPs na minha tabela de nat_oper
            //      criando o campo DERIVADO_COMBUST varchar(1) (S/N) .
            //      e criar tambem um campo na tabela de produtos denominado
            //      "CODIGO_SIMP_ANP" VARCHAR(9) (Codigo SIMP ANP)
            //      ( Hint: Somente se este produto estiver for PETRÓLEO/derivado e/ou constar na tabela SIMP da ANP (Agencia Nacional de PETRÓLEO).
            //        [SIMP - Sistema de INFORMACOES de Movimentaï¿½ï¿½o de Produtos da ANP]
            //        Veja Tabela:T012-Codigos_de_produtos_20150803.xls
            //      )
            // Veja tabela de CFOP de petroleo em:
            // "D:\T\TradeCompo_Oficial\TecnoSpeed_Docs_NFe\Outros\CFOPS_Petroleo_e_Derivados.doc"
            //

            if Contido(sTMP_CFOP_I08,
               '|1650|1651|1652|1653|1658|1659|1660|1661|1662|1663|1664'  +
               '|2650|2651|2652|2653|2658|2659|2660|2661|2662|2663|2664'  +
               '|3650|3651|3652|3653'                                     +
               '|5650|5651|5652|5653|5654|5655|5656|5657'                 +
               '|5658|5659|5660|5661|5662|5663|5664|5665|5666'            +
               '|6650|6651|6652|6653|6654|6655|6656|6657|6658'            +
               '|6659|6660|6661|6662|6663|6664|6665|6666'                 +
               '|7650|7651|7654|')
            then
            (* Saida/Entrada de combustï¿½vel ou ï¿½leo lubrificante, ï¿½ muito comum OLEO LUBRIFICANTE EM AUTO PEï¿½AS *)
            begin

               sTMP_cProdANP_LA02 := '620505001';

               {
               - Veja a tabela de codigos SIMP da ANP em:
                 "D:\T\TradeCompo_Oficial\TecnoSpeed_Docs_NFe\Outros\SIMP_i-SIMP_ANP\Tab_Codigos\0_T012-Codigos_de_produtos_20150803.xls"
               - Este codigo padrao(default) que adotei "620505001", esta discriminado na tabela acima
                 da seguinte forma:

                 - Famï¿½lia                : ï¿½LEOS LUBRIFICANTES, PARAFINAS E GRAXAS
                 - Grupo                  : ï¿½LEOS LUBRIFICANTES ACABADOS
                 - Sub-Grupo              : ï¿½LEOS LUBRIFICANTES AUTOMOTIVOS
                 - Sub-Subgrupo           : OUTROS ï¿½LEOS LUBRIFICANTES AUTOMOTIVOS
                 - Produto                : OUTROS ï¿½LEOS LUBRIFICANTES AUTOMOTIVOS
                 - Codigo                 : 620505001
                 - Unidade de Grandeza    : VOLUME
                 - Unidade de Medida SIMP : L
                 - Ramo                   : vazio
                 - Data Inï¿½cio Validade   : 200409
                 - Data Final Validade    : vazio
               }

               //Criar uma tela que vai obter os seguintes dados:
               {
               sTMP_cProdANP_LA02 - Codigo do produto na ANP
               sTMP_UFCons_LA06   - UF do cliente
               sTMP_descANP_LA03  - DESCRICAO do produto na ANP
               sTMP_pGLP_LA03a    - Percentual de GLP
               sTMP_pGNn_LA03b    - Percentual de Gas Natural Nacional
               sTMP_pGNi_LA03c    - Percentual de Gas Natural Importado
               sTMP_vPart_LA03d   - Valor de Partida
               }

               sTMP_cProdANP_LA02 := DialogoBox
                   (
                   'VOCÊ INFORMOU CFOP DE PETRÓLEO OU DERIVADOS',
                    'Então digite o [Codigo de produto da ANP] para o item ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString,
                   sTMP_cProdANP_LA02 , 9, ''
                   );

               sTMP_descANP_LA03 := DialogoBox
                   (
                   'VOCÊ INFORMOU CFOP DE PETRÓLEO OU DERIVADOS',
                    'Então digite o [DESCRICAO do produto conforme ANP] para o item ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString,
                   sTMP_descANP_LA03 , 9, ''
                   );

               if(sTMP_cProdANP_LA02 = '210203001')then
               begin

                  sTMP_pGLP_LA03a := DialogoBox
                   (
                   'VOCÊ INFORMOU CFOP DE PETRÓLEO OU DERIVADOS',
                    'Então digite o [Percentual de GLP] para o item ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString,
                   sTMP_pGLP_LA03a , 9, ''
                   );

                  sTMP_pGNn_LA03b := DialogoBox
                   (
                   'VOCÊ INFORMOU CFOP DE PETRÓLEO OU DERIVADOS',
                    'Então digite o [Percentual de Gás Natural Nacional] para o item ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString,
                   sTMP_pGNn_LA03b , 9, ''
                   );

                  sTMP_vPart_LA03d := DialogoBox
                   (
                   'VOCÊ INFORMOU CFOP DE PETRÓLEO OU DERIVADOS',
                    'Então digite o [Valor de Partida] para o item ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString,
                   sTMP_vPart_LA03d , 9, ''
                   );

                  Prod.comb.pGLP := StringToFloatDef(sTMP_pGLP_LA03a, 0);
                  Prod.comb.pGNn := StringToFloatDef(sTMP_pGNn_LA03b, 0);
                  Prod.uTrib := 'KG';
                  Prod.comb.vPart := StringToFloatDef(sTMP_vPart_LA03d, 0);
                  			   
               end;

               Prod.comb.cProdANP := StrToInt(sTMP_cProdANP_LA02);
               Prod.comb.descANP := sTMP_descANP_LA03;
               sTMP_UFCons_LA06 := Trim(QRecupVen_NF.FieldByName('ESTADO_CLI').AsString);
               Prod.comb.UFcons := sTMP_UFCons_LA06;
            
            end;

            sTMP := Trim(MostraCampoString('PRODUTOS', 'CODIGO' , QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString , 'MEDIDA', ''));
            Prod.uCom := sTmp;

            sFormatoFloat := MascDecValid(QRecupVen_Itens.FieldByName('QTDE').AsString, 'DECMIN=0', 'DECMAX=4');
            sTMP := TrocaVirgulaPorPonto(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('QTDE').AsFloat ));
            Prod.qCom := StringToFloatDef(sTMP, 0);

            sFormatoFloat := MascDecValid(QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsString, 'DECMIN=2', 'DECMAX=' + sQtdDecimaisValorUnitario);
            sTMP := TrocaVirgulaPorPonto(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsFloat ));
            Prod.vUnCom := StringToFloatDef(sTMP, 0);

            if (( Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) <> '5933') and (Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) <> '6933')) then
            begin

               vValorTotProd := QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;
               sFormatoFloat := MascDecValid(FloatToStr(vValorTotProd), 'DECMIN=2', 'DECMAX=2');
               vValorTotProdDif := vValorTotProdDif + StrToFloat(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('VALOR_TOTAL'   ).AsFloat));

            end
            else
            begin

               sFormatoFloat := MascDecValid(FloatToStr(QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat), 'DECMIN=2', 'DECMAX=2');
               vValorTotProd := 0;

            end;

            sTMP := TrocaVirgulaPorPonto(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('VALOR_TOTAL'   ).AsFloat ));
            Prod.vProd := StringToFloatDef(sTMP, 0);

            sTMP := Trim(sEAN_I03);
            Prod.cEANTrib := sTMP;

            sTMP := Trim(MostraCampoString('PRODUTOS', 'CODIGO' , QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString , 'MEDIDA', ''));
            Prod.uTrib := sTMP;

            sFormatoFloat := MascDecValid(QRecupVen_Itens.FieldByName('QTDE').AsString, 'DECMIN=0', 'DECMAX=4');
            sTMP     := TrocaVirgulaPorPonto(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('QTDE').AsFloat ));
            Prod.qTrib := StringToFloatDef(sTMP, 0);

            sFormatoFloat := MascDecValid(QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsString, 'DECMIN=2', 'DECMAX=' + sQtdDecimaisValorUnitario);
            sTMP := TrocaVirgulaPorPonto(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsFloat ));
            Prod.vUnTrib := StringToFloatDef(sTMP, 0);

            sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaFrete_BD()  )));
            vValorTotFreteDif := vValorTotFreteDif + strtofloat(FormatFloat('##0.00', RateiaFrete_BD()));
            Prod.vFrete := StringToFloatDef(sTMP, 0);

            sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaSeguro_BD() )));
            Prod.vSeg := StringToFloatDef(sTMP,0);

            /////////////////////////////////////////////////////////////////////////
            // Inicio_vDesc_I17 - Validando se "v Desc_W10" bate com a soma de "v Desc_I17"
            /////////////////////////////////////////////////////////////////////////

            nTMP_vDesc_I17 := (QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat - QRecupVen_Itens.FieldByName('VALOR_TOTAL_COM_DESCONTO').AsFloat);
            nTMP_vDesc_I17 := ArredondaValor(nTMP_vDesc_I17,2);

            if vDiferenca > 0 then
            begin

               // Diferenï¿½a Positiva
               if nTMP_vDesc_I17 >= vDiferenca then
               begin
                  nTMP_vDesc_I17 := nTMP_vDesc_I17 - vDiferenca;
                  vDiferenca := 0;
               end;

            end
            else
            if vDiferenca < 0 then
            begin
               // Diferenï¿½a negativa
               nTMP_vDesc_I17 := nTMP_vDesc_I17 + ABS(vDiferenca);
               vDiferenca := 0;
            end;

            vTotalDescontoItens := vTotalDescontoItens + nTMP_vDesc_I17;
            sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', nTMP_vDesc_I17)));
            Prod.vDesc := StringToFloatDef(sTMP, 0);

            if true then
            begin

               nSoma_vOutroI17a_WORK := nSoma_vOutroI17a_WORK + ArredondaValor(RateiaOutrasDesp_BD(), 2);
               ///////////////////////////////////////////////////////////////////////////////////////////
               // Verificando se ï¿½ o ultimo item, se sim, entao deve acrescentar ou retirar a diferenca
               // de dizimas periodicas que costuma dar entre "vOutro_W15" e a somatoria de "vOutro_I17a"
               ///////////////////////////////////////////////////////////////////////////////////////////

               nDif_Diminuir := 0;
               nDif_Somar    := 0;

               if iNumeroDoItem = QRecupVen_Itens.RecordCount then
               begin

                  if nSoma_vOutroI17a_WORK > QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat then
                  begin
                     nDif_Diminuir := nSoma_vOutroI17a_WORK - QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat;
                     sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaOutrasDesp_BD() - nDif_Diminuir )));
                  end
                  else if nSoma_vOutroI17a_WORK < QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat then
                  begin
                     nDif_Somar := QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat - nSoma_vOutroI17a_WORK;
                     sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaOutrasDesp_BD() + nDif_Somar    )));
                  end
                  else
                  begin
                     sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaOutrasDesp_BD() + 0000000000    )));
                  end;

                  Prod.vOutro := StringToFloatDef(sTMP, 0);

                  if(oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe <> StrToFinNFe(bOut,'4'))then
                  begin

                     if(vValorTotProdLocal > 0)then
                     begin

                        if(vValorTotProdDif <> vValorTotProdLocal)then
                        begin

                           vValorTotProdDif := vValorTotProdLocal - vValorTotProdDif;
                           sFormatoFloat := MascDecValid(FloatToStr(vValorTotProd), 'DECMIN=2', 'DECMAX=2');
                           vValorTotProdDif := vValorTotProdDif + strtofloat(FormatFloat(sFormatoFloat, QRecupVen_Itens.FieldByName('VALOR_TOTAL'   ).AsFloat ));
                           vValorTotProd := vValorTotProdDif;
                           Prod.vProd := StringToFloatDef(TrocaPontoPorVirgula(FormatFloat(sFormatoFloat, vValorTotProdDif )), 0);

                        end;

                     end;

                     if(C_VrFrete.Value > 0)then
                     begin

                        if(vValorTotFreteDif <> C_VrFrete.Value)then
                        begin

                           vValorTotFreteDif := C_VrFrete.Value - vValorTotFreteDif;
                           sFormatoFloat := MascDecValid(FloatToStr(vValorTotProd), 'DECMIN=2', 'DECMAX=2');
                           vValorTotFreteDif := vValorTotFreteDif + strtofloat(FormatFloat(sFormatoFloat, RateiaFrete_BD() ));
                           Prod.vFrete := StringToFloatDef(TrocaPontoPorVirgula(FormatFloat(sFormatoFloat, vValorTotFreteDif )), 0);

                        end;

                     end;

                     if(C_IcmsSubst.Value > 0)then
                     begin

                        if(vValorTotIcmsStDif <> C_IcmsSubst.Value)then
                        begin
                           vValorTotIcmsStDif := C_IcmsSubst.Value - vValorTotIcmsStDif;
                           sFormatoFloat := MascDecValid(FloatToStr(vValorTotProd), 'DECMIN=2', 'DECMAX=2');
                           vValorTotIcmsStDif := vValorTotIcmsStDif + strtofloat(FormatFloat('##0.00', Rateia_VrIcmsST_BD(QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsInteger, QRecupVen_Itens.FieldByName('VALOR_UNITARIO').AsFloat * QRecupVen_Itens.FieldByName('QTDE').AsFloat,  QRecupVen_Itens.RecordCount)));
                           sTMP_vICMSST_N23 := TrocaVirgulaPorPonto( FormatFloat('##0.00', vValorTotIcmsStDif ));
                        end;

                     end;

                  end
                  else
                  begin

                     vValorTotProdDif := 0;
                     vValorTotFreteDif := 0;
                     vValorTotIcmsStDif := 0;

                  end;

               end
               else
               begin

                  sTMP := Facult(TrocaVirgulaPorPonto(FormatFloat('##0.00', RateiaOutrasDesp_BD() )));
                  Prod.vOutro := StringToFloatDef(sTMP, 0);

               end;

            end;

            //-----------------------------------------
            //-- Manutenção Emergencial MM Máquinas ---
            //-- Grupo Declaração de Importação -------
            //-- Valores fixados para emitir nota -----
            //-- com urgência, dia 25/11/2022  --------
            //-----------------------------------------
            
            if Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)) = '22.889.525/0001-62' then  //MM MAQUINAS
            begin
               try
                  qProdDI := ConsultaBanco('SELECT * FROM PRODUTO_DI WHERE CODIGO_PRODUTO = '+QuotedStr(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString));
                  if not qProdDi.isEmpty then
                  begin
                     Prod.uTrib := qProdDI.FieldByName('uTrib').asString;
                     Prod.vOutro := qProdDI.FieldByName('vOutro').asFloat;
                     Prod.qTrib := qProdDI.FieldByName('qTrib').asFloat;
                     Prod.vUnTrib := qProdDI.FieldByName('vUnTrib').asFloat;     
                  end;
               finally
               end;
            end;

            /////////////////////////////////////////////////////////////////////////
            // Fim_vDesc_I17
            /////////////////////////////////////////////////////////////////////////

            sTMP := '1';
            Prod.IndTot := StrToindTot(bOut, '1');

            DadosImpostoItem(oACBRNFe, iNumeroDoItem - 1);
            DadosInformacoesAdic(oACBRNFe, iNumeroDoItem - 1);

         end;

         QRecupVen_Itens.Next;

         while not QRecupVen_Itens.eof do
         begin

            if (Trim(QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString) = '') then
               QRecupVen_Itens.Next
            else
               break;

         end; {while}

      end;{while}

   end;

   function DadosTotaisACBR(var oACBRNFe: TACBrNFe): Boolean;
      var qProdDI : TSQLQuery;
   begin            

      with oACBRNFe.NotasFiscais[0].NFe.Total do
      begin

         // Incluir totalizadores da nota

         ICMSTot.vBC := StringToFloatDef(FormatFloat('##0.00',  nTotalBase_ICMS), 0);
         ICMSTot.vICMS := StringToFloatDef(FormatFloat('##0.00', nTotICMS), 0);
         ICMSTot.vICMSDeson := 0;
         ICMSTot.vBCST := StringToFloatDef(FormatFloat('##0.00',  QRecupVen_NF.FieldByName   ('BASE_CALC_ICMS_SUB' ).AsFloat), 0);
         ICMSTot.vST := StringToFloatDef(FormatFloat('##0.00',  QRecupVen_NF.FieldByName   ('VR_ICMS_SUB'        ).AsFloat), 0);

         if nTotal_ICMS_Deson > 0 then
            ICMSTot.vICMSDeson := nTotal_ICMS_Deson;

         // Caso onde EXISTE SOMENTE SERVICO na nf
         if (nQtde_CFOP_5933 > 0) and (nQtde_CFOP_DIF_5933 = 0) then
            ICMSTot.vProd := 0;

         // Caso onde EXISTE PRODUTO na nf independente de existir servico
         if nQtde_CFOP_DIF_5933 > 0 then
            ICMSTot.vProd := StringToFloatDef(FormatFloat('##0.00',  nTot_vProd_W07   ), 0);

         ICMSTot.vFrete := StringToFloatDef(FormatFloat('##0.00',  QRecupVen_Basic.FieldByName('FRETE').AsFloat), 0);
         ICMSTot.vSeg := StringToFloatDef(FormatFloat('##0.00',  QRecupVen_NF.FieldByName('SEGURO').AsFloat), 0);
         ICMSTot.vDesc := StringToFloatDef(FormatFloat('##0.00',  vTotalDescontoItens ), 0);


         //-----------------------------------------
         //-- Manutenção Emergencial MM Máquinas ---
         //-- Grupo Declaração de Importação -------
         //-- Valores fixados para emitir nota -----
         //-- com urgência, dia 25/11/2022  --------
         //-----------------------------------------

         ICMSTot.vII := nTotII;

         //-----------------------------------------


         if(oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe <> StrToFinNFe(bOut, '4'))then
         begin
            ICMSTot.vIPI := StringTOFloatDef(FormatFloat('##0.00',  nTotIPI        ), 0);
         end
         else
            ICMSTot.vIPI := 0;

         if (oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '4')) then // COMPLEMENTAR TEMPORARIO
            // ICMSTot.vIPIDevol := CalculaTotaisIPIDevol(oACBRNFe) //StringToFloatDef(FormatFloat('##0.00',  nTotIPI        ), 0)
         begin
            ICMSTot.vIPIDevol := CalculaTotaisIPIDevol(oACBRNFe); //StringToFloatDef(FormatFloat('##0.00',  nTotIPI        ), 0)
            nTotIPI := ICMSTot.vIPIDevol;
         end
         else
            ICMSTot.vIPIDevol := 0;

         //Teste
         ICMSTot.vPIS := nTotPIS;
         ICMSTot.vCOFINS := nTotCOFINS;
         //---
         
         ICMSTot.vPIS := StringToFloatDef(FormatFloat('##0.00',QRecupVen_NF.FieldByName('VR_PIS_W13').AsFloat), 0);
         ICMSTot.vCOFINS := StringToFloatDef(FormatFloat('##0.00',QRecupVen_NF.FieldByName('VR_COFINS_W14').AsFloat), 0);


         ICMSTot.vOutro := StringToFloatDef(FormatFloat('##0.00', QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat), 0);

         sTMP :=
            TrocaVirgulaPorPonto
            (
              FormatFloat
              (
                '##0.00',
                ((nTotalProd + nTotalServ) - vTotalDescontoItens) +
                //nTotIPI + QRecupVen_Basic.FieldByName('FRETE' ).AsFloat +
                nTotIPI + nTotFrete + nTotFCPST +
                QRecupVen_NF.FieldByName('SEGURO'             ).AsFloat +
                QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat +
                QRecupVen_NF.FieldByName('VR_ICMS_SUB'        ).AsFloat
              )
            );


         //-----------------------------------------
         //-- Manutenção Emergencial MM Máquinas ---
         //-- Grupo Declaração de Importação -------
         //-- Valores fixados para emitir nota -----
         //-- com urgência, dia 25/11/2022  --------
         //-----------------------------------------

         if Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)) = '22.889.525/0001-62' then  //MM MAQUINAS
         begin
            try
               qProdDI := ConsultaBanco('SELECT * FROM PRODUTO_DI ');
               if not qProdDi.isEmpty then
               begin
                  sTMP :=
                  TrocaVirgulaPorPonto
                  (
                    FormatFloat
                    (
                      '##0.00',
                      ((nTotalProd + nTotalServ) - vTotalDescontoItens) +
                      nTotIPI + nTotICMS +
                      QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat

                    )
                  );
               end;
            finally
               FreeAndNil(qProdDI);
            end;
         end;

         //-----------------------------------------

         ICMSTot.vNF := StringToFloatDef(TrocaPontoPorVirgula(sTMP), 0);

         if nQtde_CFOP_5933 > 0 then
         begin

            // Caso onde EXISTE SERVICO na nf independente de existir produto
            ISSQNtot.vBC := StringToFloatDef(FormatFloat( '##0.00', (nTotalServ - nSomaDesconItem)), 0);
            ISSQNtot.vServ := StringToFloatDef(FormatFloat( '##0.00', (nTotalServ )), 0);

            if nTotISS > 0 then begin
               ISSQNtot.vISS := StringToFloatDef(FormatFloat( '##0.00', nTotISS ), 0);
            end;
            
         end;

         ICMSTot.vTotTrib := 0;
         ICMSTot.vFCPUFDest := StringToFloatDef(FormatFloat('0.00', FGrupoIcmsUFDest.vFCPUFDest), 0);
         ICMSTot.vICMSUFDest := StringToFloatDef(FormatFloat('0.00', FGrupoIcmsUFDest.vICMSUFDest), 0);
         ICMSTot.vICMSUFRemet := StringToFloatDef(FormatFloat('0.00', FGrupoIcmsUFDest.vICMSUFRemet), 0);
         ICMSTot.vFCP := StringToFloatDef(FormatFloat('##0.00',  nTotFCP       ), 0);
         ICMSTot.vFCPST := StringToFloatDef(FormatFloat('##0.00',  nTotFCPST       ), 0);
         ICMSTot.vFCPSTRet := 0;

         ////////////////////////////////////////////////////////////////////
         //           CHEQUE MORADIA (TOTAIS) (Transferencia de Credito)   //
         ////////////////////////////////////////////////////////////////////

         //Se o CFOP for (5601,5601 ou 6949)
         //Se for finNFE = 3 (Ajuste)
         //Se Natureza de Operacao for TRANSFERENCIA DE Credito DE CHEQUE MORADIA
         if((oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '3'))
             and (Trim(IntToStr(QRecupVen_NF.FieldByName('NAT_OPERACAO').AsInteger)) = iif(UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString),'240','2'))
             and (Contido(oACBRNFe.NotasFiscais[0].NFe.Det.Items[0].Prod.CFOP, '|5601|5602|6949|')))then
         begin

            //no quadro "TOTAIS", aba "ICMS", nos campos:
            //a)- VALOR TOTAL DA NOTA: o valor do Credito em TRANSFERENCIA (Pronto)
            //b)- DEMAIS CAMPOS: 0 (zero) (Fazer)
            //Verificar se sera necessario zerar algum campo
            ICMSTot.vICMS := ICMSTot.vNF;

         end;

         ////////////////////////////////////////////////////////////////////
         //     CHEQUE MORADIA (TOTAIS)  FIM  (Transferencia de Credito)   //
         ////////////////////////////////////////////////////////////////////

      end;

   end;

   function DadosTransportadoraACBR(var oACBRNFe: TACBrNFe): Boolean;
   var
      sIE : String;
   begin

      with oACBRNFe.NotasFiscais[0].NFe do
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //
         //  incluir dados referentes a transportadora
         //
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================

         // modFrete_X02 - Modalidade de Frete - verificar manual de integracao com outras possibilidades de preenchimento
         //   0- Por conta do emitente;
         //   1- Por conta do destinatï¿½rio/remetente;
         //   2- Por conta de terceiros;
         //   9- Sem frete. (V2.0)

         sCodTransp := Trim(QRecupVen_NF.FieldByName('TRANSPORT_CODIGO').AsString);

         Transp.modFrete := StrTomodFrete(bOut, Trim(QRecupVen_NF.FieldByName('CONTA_FRETE').AsString));

         // So informar esses dados cadastrais da transportadora se for cod <> 1
         if sCodTransp <> '1' then
         begin


            Transp.Transporta.CNPJCPF  := Retorna_So_Numeros( Trim(MostraCampoString('TRANSP','CODIGO',sCodTransp,'CGC_CPF','')));
            Transp.Transporta.xNome    := Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'NOME', ''));

            //Transp.Transporta.IE       := Retorna_So_Numeros(Trim(MostraCampoNumerico('TRANSP', 'CODIGO', sCodTransp, 'INSC_ESTADUAL_RG', '')));
            if Length(Transp.Transporta.CNPJCPF) = 14 then
               sIE := Trim(MostraCampoNumerico('TRANSP', 'CODIGO', sCodTransp, 'INSC_ESTADUAL_RG', ''))
            else
               sIE := '';

            Transp.Transporta.IE       := sIE;            

            Transp.Transporta.xEnder   := Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'ENDERECO', ''));
            Transp.Transporta.xMun     := Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'MUNICIPIO', ''));
            Transp.Transporta.UF       := Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'ESTADO', '')) ;


            if QRecupVen_NF.FieldByName('TRANSPORT_IMP_PLACA').AsString = 'S' then
            begin
               Transp.veicTransp.placa := RetiraCaractere(Trim(QRecupVen_NF.FieldByName('TRANSPORT_PLACA').AsString));
               Transp.veicTransp.UF    := RetiraCaractere(Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'UF_PLACA', '')));
               Transp.veicTransp.RNTC  := Trim(MostraCampoString('TRANSP', 'CODIGO', sCodTransp, 'RNTC', ''));
            end;


         end;

         // informar esses dados abaixo mesmo para transportadora nao cadastrada

         with Transp.Vol.Add do
         begin

            qVol  := StrToInt(Trim(IntToStr(QRecupVen_NF.FieldByName('QTDE').AsInteger)));
            esp   := Trim(QRecupVen_NF.FieldByName('ESPECIE').AsString);
            marca := Trim(QRecupVen_NF.FieldByName('MARCA'  ).AsString);
            nVol  := Trim(QRecupVen_NF.FieldByName('NUMERO' ).AsString);
            pesoL := StringToFloatDef(FormatFloat('##0.000', QRecupVen_NF.FieldByName('PESO_LIQUIDO').AsFloat), 0);
            pesoB := StringToFloatDef(FormatFloat('##0.000', QRecupVen_NF.FieldByName('PESO_BRUTO'  ).AsFloat), 0);

            if(Trim(QRecupVen_NF.FieldByName('LACRE_VOLUME').AsString) <> '')then
               with Lacres.Add do
               begin

                  nLacre := Trim(QRecupVen_NF.FieldByName('LACRE_VOLUME').AsString);

               end;

         end;

      end;

   end;

   function DadosInfoAdicionaisNFACBR(var oACBRNFe: TACBrNFe): Boolean;
   var
      iIndiceCheques: Integer;
      sIPIDev : String;
      nValorIPIDev : Double;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.InfAdic do
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //
         //  incluir dados adicionais (Observacao)
         //
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================

         sIPIDev := '';
         nValorIPIDev := 0;
         nValorIPIDev :=  CalculaTotaisIPIDevol(oACBRNFe);

         //Mensagem de IPI Devolução deve vir antes
         if nValorIPIDev > 0 then
         begin
            sIPIDev := 'INFORMAÇÃO FISCO: Valor do IPI devolvido: '+FormatFloat('##0.00' ,  nValorIPIDev )+';';
         end
         else
         begin
            QRecupVen_Itens.First;
            if (not ((ConfigSemErro('TXT', 'Empresa-Industria') = 'S') and (ConfigSemErro('TXT', 'Empresa-IPIVenda') = 'S'))) and
               (CFOPdeEntrada(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) and CFOPdeDevolucao(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString))
            then
               sIPIDev := 'Não há DEVOLUÇÃO DE IPI, pois o emitente não é indústria (vendeu sem IPI);';
         end;


         if QRecupVen_NF.FieldByName('INF_CPL').AsString = '' then
         begin
            sObs := sIPIDev +
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS1').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS2').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS3').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS4').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS5').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS6').AsString), ';'),1,76)  +';'+
            Copy(RetiraCaractereEspecifico( Trim(QRecupVen_NF.FieldByName('OBS7').AsString), ';'),1,76)  +';';
         end
         else
         begin
            //Novo modelo de Informações Complementares (Memo)
            sObs := sIPIDev + QRecupVen_NF.FieldByName('INF_CPL').AsString;
         end;
            
         nAliqAproxFederal      := StrToFloat( Config('NUM', 'GERAL-ALIQ_APROX_TRIB_FEDERAIS')   );
         nAliqAproxEstadual     := StrToFloat( Config('NUM', 'GERAL-ALIQ_APROX_TRIB_ESTADUAIS')  );
         nAliqAproxMunicipal    := StrToFloat( Config('NUM', 'GERAL-ALIQ_APROX_TRIB_MUNICIPAIS') );

         nImpostoAproxFederal   := nTotalProd_IBPT * (nAliqAproxFederal/100  );
         nImpostoAproxEstadual  := nTotalProd_IBPT * (nAliqAproxEstadual/100 );
         nImpostoAproxMunicipal := nTotalProd_IBPT * (nAliqAproxMunicipal/100);

         sMsgImposto := '';
         if nAliqAproxFederal > 0 then
         begin
            if sMsgImposto = '' then
               sMsgImposto := ';Valor aproximado dos Tributos '
            else
               sMsgImposto := sMsgImposto+', ';
                   
            sMsgImposto := sMsgImposto+
                           'Federais:R$'+
                             FormatFloat('#0.00',nImpostoAproxFederal)+
                            '(' + FormatFloat('#0.00',nAliqAproxFederal)+ '%)';
         end;

         if nAliqAproxEstadual > 0 then
         begin
            if sMsgImposto = '' then
               sMsgImposto := ';Valor aproximado dos Tributos '
            else
               sMsgImposto := sMsgImposto+', ';

            sMsgImposto :=  sMsgImposto+
                            'Estaduais:R$'+
                            FormatFloat('#0.00',nImpostoAproxEstadual)+
                            '(' + FormatFloat('#0.00',nAliqAproxEstadual)  + '%)';
         end;

         if nAliqAproxMunicipal > 0 then
         begin
            if sMsgImposto = '' then
               sMsgImposto := ';Valor aproximado dos Tributos '
            else
               sMsgImposto := sMsgImposto+', ';
               
            sMsgImposto :=  sMsgImposto+
                            'Municipais:R$'+
                            FormatFloat('#0.00',nImpostoAproxMunicipal)+
                            '(' + FormatFloat('#0.00',nAliqAproxMunicipal) + '%)';
         end;
         
         if (nTMP_Soma_BC_Reduzida_PIS > 0) or (nTMP_Soma_BC_Reduzida_Cofins > 0) then
         begin
            sObs := sObs +
            '|# B.Calculo do PIS/COFINS foram reduzidas para : '           +
            'R$' + FormatFloat('#0.00',nTMP_Soma_BC_Reduzida_PIS) + ' e '  +
            'R$' + FormatFloat('#0.00',nTMP_Soma_BC_Reduzida_Cofins) + ' ' ;
         end;

         sObs := sObs + sMsgImposto;

         if sOBS_LEGAL_PARA_NF <> '' then
            sObs := sObs + '. ' + sOBS_LEGAL_PARA_NF;

         ////////////////////////////////////////////////////////////////////
         //        GERA DIREITO A CREDITO FISCAL - SIMPLES NACIONAL
         ////////////////////////////////////////////////////////////////////

         // So gerar o texto se for destinatario PJ e com IE (ou seja: contribuinte do icms)

         if ( QRecupVen_NF.FieldByName('CRT').AsString = '1'                                   )
            and
            ( Length( Retorna_So_Numeros( QRecupVen_NF.FieldByName('CGC_CPF').AsString) ) = 14 )
            and
            ( Alltrim( QRecupVen_NF.FieldByName('INSC_EST_RG').AsString) <> ''                 )
         then
         begin
            // Conclui que é um destinatario pessoa jurifica e tambem é um contribuinte pois possui IE
            nAliquota_do_mes := StrToFloat(Retorna_Zero_QuandoVazio(Config('NUM', 'NF_ALIQ_DO_MES_EPP_E_SIMPLES')));

            QRecupVen_Itens.First;
            nSoma_Valor_total := 0;
            while not QRecupVen_Itens.eof do
            begin
               nSoma_Valor_total := nSoma_Valor_total + QRecupVen_Itens.FieldByName('VALOR_TOTAL').AsFloat;
               QRecupVen_Itens.Next;
            end;

            nValor_Aproveitamento := nSoma_Valor_total * (nAliquota_do_mes / 100);

            try
               sAliquota_Aproveitamento := GetDecimaisDinamicos(FloatToStr(nAliquota_do_mes));
            except
               sAliquota_Aproveitamento := FormatCurr(',0.00', nAliquota_do_mes)
            end;

            sObs := StringReplace(sObs, '<valor_aproveitamento>', FormatCurr(',0.00', nValor_Aproveitamento), [rfReplaceAll, rfIgnoreCase]);
            sObs := StringReplace(sObs, '<aliquota_do_mes>'     , sAliquota_Aproveitamento                  , [rfReplaceAll, rfIgnoreCase]);
         end;

         ////////////////////////////////////////////////////////////////////
         //           CHEQUE MORADIA (Obs) (Transferencia de Credito)       //
         ////////////////////////////////////////////////////////////////////

         //Se o CFOP for (5601,5601 ou 6949)
         //Se for finNFE = 3 (Ajuste)
         //Se Natureza de Operacao for TRANSFERENCIA DE Credito DE CHEQUE MORADIA
         if(( oACBRNFe.NotasFiscais[0].NFe.ide.finNFe = StrToFinNFe(bOut, '3'))
             and (Trim(IntToStr(QRecupVen_NF.FieldByName('NAT_OPERACAO').AsInteger)) = iif(UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString),'240','2'))
             and (Contido( oACBRNFe.NotasFiscais[0].NFe.Det.Items[0].Prod.CFOP, '|5601|5602|6949|')))then
         begin
            //no quadro "INFORMACOES ADICIONAIS", na aba:
            //a)- "INFORMACOES ADICIONAIS", no campo "INFORMACOES ADICIONAIS DE
            //   INTERESSE DO FISCO": a expressao: "Emitida para fim de TRANSFERENCIA de Credito
            //   de Cheque Moradia - art. 11, 5, V do Anexo IX do RCTE; (Fazer)
            infAdFisco := 'Emitida para fim de TRANSFERENCIA de Credito de Cheque Moradia - art. 11,  5, V do Anexo IX do RCTE';
         end;

         ////////////////////////////////////////////////////////////////////
         //           CHEQUE MORADIA (Obs) (Transferencia de Credito) FIM  //
         ////////////////////////////////////////////////////////////////////

         ////////////////////////////////////////////////////////////////////
         //           CHEQUE MORADIA (Obs) (Venda Normal)                  //
         ////////////////////////////////////////////////////////////////////

         //Se Natureza de Operacao for VENDA COM CHEQUE MORADIA
         if(Trim(IntToStr(QRecupVen_NF.FieldByName('NAT_OPERACAO').AsInteger)) = iif(UsaTabelaNovaNatOper(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString),'008','1'))then
         begin

            //no quadro ï¿½INFORMACOES ADICIONAISï¿½, na aba:
            //a)- ï¿½INFORMACOES ADICIONAISï¿½, no campo ï¿½INFORMACOES ADICIONAIS DE
            //   INTERESSE DO FISCOï¿½: a expressï¿½o: ï¿½Emitida para fim de TRANSFERENCIA de Credito
            //   de Cheque Moradia - art. 11, ï¿½ 5ï¿½, V do Anexo IX do RCTEï¿½; (Fazer)

            //Para cada item oriundo do campo C_NumeroCheque

            if(QRecupVen_NF.FieldByName('NR_CHEQUE_MORADIA').AsString <> '')then
            begin

               sNumeroCheque := TStringList.Create;
               sNumeroCheque.Delimiter := '|';
               sNumeroCheque.DelimitedText := QRecupVen_NF.FieldByName('NR_CHEQUE_MORADIA').AsString;

               for iIndiceCheques := 0 to sNumeroCheque.Count -1 do
               begin

                  with procRef.Add do
                  begin

                     nProc := sNumeroCheque[iIndiceCheques];
                     indProc := StrToindProc(bOut, '0');

                  end;

               end;

               sNumeroCheque.Free;

            end;

            with obsFisco.Add do
            begin

               xCampo := 'VENDA COM CHEQUE MORADIA';
               xTexto := 'Venda com Cheque Moradia, nos termos do disposto no inciso II do 5o do art. 11 do Anexo IX do RCTE';

            end;
            
         end;

         ////////////////////////////////////////////////////////////////////
         //           CHEQUE MORADIA (Obs) (Venda Normal)             FIM  //
         ////////////////////////////////////////////////////////////////////

         infCpl := Trim(sObs);

      end;

      ///////////////////////////////////
      // PEDIDO DE COMPRA      INICIO  //
      ///////////////////////////////////

      if Trim(QRecupVen_NF.FieldByName('PEDIDO_COMPRA').AsString) <> '' then

      with oACBRNFe.NotasFiscais[0].NFe.compra do
      begin
         xPed := QRecupVen_NF.FieldByName('PEDIDO_COMPRA').AsString;
      end;

      ///////////////////////////////////
      // PEDIDO DE COMPRA      FIM     //
      ///////////////////////////////////

   end;

   function DadosFaturaACBR(var oACBRNFe: TACBrNFe): Boolean;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.Cobr do
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //
         //  incluir dados da fatura
         //
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================

         // nFat_Y03     - Numero da Farura
         // vOrig_Y04    - Valor Original da Fatura
         // vDesc_Y05    - Valor do Desconto
         // vLiq_Y06     - Valor Lï¿½quido da Fatura


         //Campos obrigatorios NF4.00
         //Campo('nFat_Y03').Value  := '0';
         //Campo('vOrig_Y04').Value := '0';
         //Campo('vDesc_Y05').Value := '0';

         sTMP2 :=
               TrocaVirgulaPorPonto
               (
                 FormatFloat
                 (
                   '##0.00',
                   (nTotalProd - vTotalDescontoItens) +
                   //nTotIPI + QRecupVen_Basic.FieldByName('FRETE' ).AsFloat +
                   nTotIPI + nTotFrete + nTotFCPST +
                   QRecupVen_NF.FieldByName('SEGURO'             ).AsFloat +
                   QRecupVen_NF.FieldByName('DESPESAS_ACESSORIAS').AsFloat +
                   QRecupVen_NF.FieldByName('VR_ICMS_SUB'        ).AsFloat
                 )
               );
            fim;

         QRecupVen_Plano.First;
         while not QRecupVen_Plano.Eof do
         begin

            sNaturezaPlanoPgto := MostraCampoNumerico('PLANOS_PG', 'CODIGO_PLANO' , QRecupVen_Plano.FieldByName('CODIGO_PLANO').AssTring, 'NATUREZA' , '');

            if (sNaturezaPlanoPgto='BOLETO') or (sNaturezaPlanoPgto='ACUMULATIVO') or
               (sNaturezaPlanoPgto='CARNE' ) or (sNaturezaPlanoPgto='PROMISSORIA') then
            begin

               with Dup.Add do
               begin

                  bPossuiParcelas := True;

                  nDuplicata := nDuplicata + 1;
                  nLiqFatura := nLiqFatura + QRecupVen_Plano.FieldByName('VALOR').AsFloat;

                  if(nDuplicata < 10)then
                     sTMP := '00' + IntToStr(nDuplicata)
                  else if(nDuplicata < 99)then
                     sTMP := '0' + IntToStr(nDuplicata)
                  else if(nDuplicata > 99)then
                        sTMP := IntToStr(nDuplicata);

                  nDup  := sTMP;
                  dVenc := QRecupVen_Plano.FieldByName('VENCIMENTO').AsDateTime;
                  vDup  := StringToFloatDef(FormatFloat('###0.00', QRecupVen_Plano.FieldByName('VALOR').AsFloat), 0);
                        
                  //Retenções
                  if QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value > 0 then
                  begin
                     if QRecupVen_Plano.RecordCount > 1 then
                     begin
                        ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                        Abort;
                     end;
                     vDup := StringToFloatDef(FormatFloat('###0.00', vDup - QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value),0);
                  end;

                  if QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value > 0 then
                  begin
                     if QRecupVen_Plano.RecordCount > 1 then
                     begin
                        ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                        Abort;
                     end;
                     vDup := StringToFloatDef(FormatFloat('###0.00', vDup - QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value),0);
                  end;
                  
                  if QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value > 0 then
                  begin
                     if QRecupVen_Plano.RecordCount > 1 then
                     begin
                        ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                        Abort;
                     end;
                     vDup := StringToFloatDef(FormatFloat('###0.00', vDup - QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value),0);
                  end;
               end;

            end;

            QRecupVen_Plano.Next;
            
         end;

         //Campos da Fatura
         if bPossuiParcelas then
         begin

            Fat.vLiq := StringToFloatDef(FormatFloat('###0.00', nLiqFatura), 0);
            Fat.nFat := '001';
            Fat.vOrig := StringToFloatDef(FormatFloat('###0.00', nLiqFatura), 0);
            Fat.vDesc := 0;


            //Retenções
            if QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value > 0 then
            begin
               Fat.vDesc := StringToFloatDef(FormatFloat('###0.00', Fat.vDesc + QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value),0);
               Fat.vLiq := StringToFloatDef(FormatFloat('###0.00', Fat.vLiq - QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value),0);
            end;

            if QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value > 0 then
            begin
               Fat.vDesc := StringToFloatDef(FormatFloat('###0.00', Fat.vDesc + QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value),0);
               Fat.vLiq := StringToFloatDef(FormatFloat('###0.00', Fat.vLiq - QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value),0);
            end;

            if QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value > 0 then
            begin
               Fat.vDesc := StringToFloatDef(FormatFloat('###0.00', Fat.vDesc + QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value),0);
               Fat.vLiq := StringToFloatDef(FormatFloat('###0.00', Fat.vLiq - QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value),0);
            end;


            bPossuiParcelas := False;

         end;

      end;

   end;

   function DadosExportacaoACBR(var oACBRNFe: TACBrNFe): Boolean;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.exporta do
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //
         //  Dados de exportacao
         //
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================


         if (QRecupVen_NF.FieldByName('ESTADO_CLI').AsString = 'EX') and
            (QRecupVen_NF.FieldByName('OPERACAO').AsString <> 'E') //Entrada é importação 
         then
         begin

            //Deixar o usuario informar esses dois campos, ao invez de assumir como sendo mesmo ESTADO_CLI
            UFSaidaPais := Trim(MostraCampoString('config','SECAO_CAMPO','EMPRESA-UF', 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            xLocExporta := Trim(MostraCampoString('config','SECAO_CAMPO','EMPRESA-CIDADE', 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            
         end;

      end;

   end;

   function DadosPagamentoACBR(var oACBRNFe: TACBrNFe): Boolean;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.pag do
      begin

         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================
         //
         //  Grupo dados de Pagamento
         //
         //=========================================================================================
         //?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?>?
         //=========================================================================================

         QRecupVen_Plano.First;

         if(QRecupVen_Plano.IsEmpty)then
         begin

            with Add do
            begin

               tPag := StrToFormaPagamento(bOut,'01');
               vPag := 0;

            end;

         end;

         while not QRecupVen_Plano.Eof do
         begin

            with Add do
            begin
               if (QRecupVen_Plano.FieldByName('NOME').AsString = 'TRANSF BANCÁRIA') then
               begin
                  //TODO: ARRUMAR, FEITO RAPIDAMENTE PARA CLIENTE CEZAR REZENDE
                  tPag := StrToFormaPagamento(bOut,'18')
               end
               else
               if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'dinheiro') then

                  tPag := StrToFormaPagamento(bOut,'01')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cheque') then

                  tPag := StrToFormaPagamento(bOut,'02')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cheq pre') then

                  tPag := StrToFormaPagamento(bOut,'02')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cheq vista') then

                  tPag := StrToFormaPagamento(bOut,'02')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'chq c/cons.') then

                  tPag := StrToFormaPagamento(bOut,'02')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cartao cre') then

                  tPag := StrToFormaPagamento(bOut,'03')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cartao deb') then

                  tPag := StrToFormaPagamento(bOut,'04')
                //todo verificar XSD pix
               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'pix') then
               begin
                  tPag := StrToFormaPagamento(bOut,'17');
                  tpIntegra := StrTotpIntegra(bOut, '2');
               end
               else if ( (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'carne'       ) or
                         (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'promissoria' ) or
                         (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'boleto'      ) or
                         (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'acumulativo' )
                       )
                       then

                  tPag := StrToFormaPagamento(bOut,'05')

               else if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'ticket') then

                  tPag := StrToFormaPagamento(bOut,'11')

               else
               begin
                  tPag := StrToFormaPagamento(bOut,'99');
                  // todo verificar versão acbr e xsd - descrição do meio de pgto outros                  
                  xPag := QRecupVen_Plano.FieldByName('NATUREZA').AsString;
               end;


               if (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cartao cre')
                  or
                  (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'cartao deb')
                  //or
                  //(LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString) = 'pix')
               then
               begin
                  tpIntegra := StrTotpIntegra(bOut, '2');
               end;

               //Bandeiras
               if FileExists(ExtractFilePath(ParamStr(0)) + 'bandeiras.ini') and
                  (tPag in [StrToFormaPagamento(bOut,'03'),StrToFormaPagamento(bOut,'04')]) then
               begin
                  if Trim(LeArquivoIni(ExtractFilePath(ParamStr(0)) + 'bandeiras.ini', 'BANDEIRAS', (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString)))) <> '' then
                  begin
                     CNPJ  := Retorna_So_Numeros(Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)));
                     tBand := StrToBandeiraCartao(bOut,Trim(LeArquivoIni(ExtractFilePath(ParamStr(0)) + 'bandeiras.ini', 'BANDEIRAS', (LowerCase(QRecupVen_Plano.FieldByName('NATUREZA').AsString)))));
                  end
                  else
                  begin
                     CNPJ  := Retorna_So_Numeros(Config('TXT','EMPRESA-CGC', intToStr(iCodigoFilial_NF)));
                     tBand := bcVisa;
                  end;
               end;


               nValorPlano := QRecupVen_Plano.FieldByName('VALOR').AsFloat;
               vPag := StringToFloatDef(FormatFloat('###0.00', nValorPlano), 0);

               nValorRetISS := 0;
               nValorRetINSS := 0;
               nValorRetTEC := 0;

               //Retenções
               if (QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value > 0) then
               begin
                  if QRecupVen_Plano.RecordCount > 1 then
                  begin
                     ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                     Abort;
                  end;
                  nValorRetINSS := StringToFloatDef(FormatFloat('###0.00',QRecupVen_NF.FieldByName('VALOR_RET_INSS').Value),0);
                  vPag := vPag - nValorRetINSS;
               end;

               if  (QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value > 0) then
               begin
                  if QRecupVen_Plano.RecordCount > 1 then
                  begin
                     ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                     Abort;
                  end;
                  nValorRetISS := StringToFloatDef(FormatFloat('###0.00', QRecupVen_NF.FieldByName('VALOR_RET_ISS').Value),0);
                  vPag := vPag - nValorRetISS;
               end;

               if (QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value > 0) then
               begin
                  if QRecupVen_Plano.RecordCount > 1 then
                  begin
                     ExibeMensagem('Atenção!|Ainda não há suporte para Retenção Técnica/ISS/INSS para múltiplas parcelas.||Contate o suporte para maiores informações.','Atenção!',Erro);
                     Abort;
                  end;               
                  nValorRetTEC := StringToFloatDef(FormatFloat('###0.00', QRecupVen_NF.FieldByName('VALOR_RET_TEC').Value),0);
                  vPag := vPag - nValorRetTEC;
               end;

               //Versão 4.00
               if(QRecupVen_Basic.FieldByName('TROCO').AsFloat > 0) then
                  vTroco := StringToFloatDef(FormatFloat('###0.00', QRecupVen_Basic.FieldByName('TROCO').AsFloat), 0);

               // NT 2016.002 v1.5
               if((oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '3'))or(oACBRNFe.NotasFiscais[0].NFe.Ide.finNFe = StrToFinNFe(bOut, '4')))then
               begin
                  tPag := StrToFormaPagamento(bOut, '90');
                  vPag := 0;
               end;

               QRecupVen_Plano.Next;

            end;

         end;

      end;


   end;

   function DadosRespTecACBR(var oACBRNFe: TACBrNFe): boolean;
   begin

      with oACBRNFe.NotasFiscais[0].NFe.infRespTec do
      begin

         //Grupo de informacoes do Responsavel Tecnico ###############################################
         if(ConfigSemErro('TXT', 'ENVIA_RESPONSAVEL_TECNICO')='1')then
         begin

            CNPJ := Retorna_So_Numeros(ConfigSemErro('TXT', 'CNPJ_RESPONSAVEL_TECNICO'));
            xContato := Trim(ConfigSemErro('TXT', 'NOME_CONTATO_RESPONSAVEL_TECNICO'));
            email := trim(ConfigSemErro('TXT', 'EMAIL_RESPONSAVEL_TECNICO'));
            fone := trim(ConfigSemErro('TXT', 'TELEFONE_RESPONSAVEL_TECNICO'));

            //Dados de Seguranca do responsavel tecnico
            idCSRT := strToInt(retorna_so_numeros(ConfigSemErro('TXT', 'IDCSRT_RESPONSAVEL_TECNICO')));

         end;

      end;

   end;



begin
   FGrupoIcmsUFDest := TICMSTotComponent.Create(Self);

   with F_NF010_Dados_Entra, F_NF150_Env_Trata_Erros do
   begin


      try

         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         // Abastraindo dados da NF a ser gerado seu XML
         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101a',''); QRecupVen_Basic := CriaQueryTabX(QRecupVen_Basic, 'select * from VEN_BASIC where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption + ' and FILIAL = ' + IntToStr(iCodigoFilial_NF) ); LogEnviaNFe(sArqLogEnvioNFe, '15040219260101b','');
         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101c',''); QRecupVen_Orca  := CriaQueryTabX(QRecupVen_Orca,  'select * from VEN_ORCA  where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption )                                             ; LogEnviaNFe(sArqLogEnvioNFe, '15040219260101d','');
         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101e',''); QRecupVen_NF    := CriaQueryTabX(QRecupVen_NF,    'select * from VEN_NF    where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption )                                             ; LogEnviaNFe(sArqLogEnvioNFe, '15040219260101f','');
         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101g',''); QRecupVen_Itens := CriaQueryTabX(QRecupVen_Itens, 'select cast(vi.valor_unitario as double precision) as valor_unitario, vi.* from VEN_ITENS vi where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption )                                             ; LogEnviaNFe(sArqLogEnvioNFe, '15040219260101h',''); // ' Order by ORDEM_ITEM');
         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101i',''); QRecupVen_Serv  := CriaQueryTabX(QRecupVen_Serv,  'select * from VEN_SERV  where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption + ' Order by ORDEM_ITEM')                     ; LogEnviaNFe(sArqLogEnvioNFe, '15040219260101j','');
         LogEnviaNFe(sArqLogEnvioNFe, '15040219260101k',''); QRecupVen_Plano := CriaQueryTabX(QRecupVen_Plano, 'SELECT * FROM VEN_PLANO LEFT JOIN PLANOS_PG ON PLANOS_PG.CODIGO_PLANO = VEN_PLANO.CODIGO_PLANO where CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption + ' Order by VENCIMENTO')                     ; LogEnviaNFe(sArqLogEnvioNFe, '15040219260101l','');

         /////////////////////////////////////////////////////////////////////////////////////////////////
         // Algunas validacoes (por garantia) que por acaso tenha passado pelos validadores :
         // "F_NF070_Dados_Valida_Itens"
         // "F_NF070_Dados_Valida_Cliente"
         // "F_NF070_Dados_Valida_Fechamento"
         /////////////////////////////////////////////////////////////////////////////////////////////////

         if ( Trim(QRecupVen_NF.FieldByName('CONTA_FRETE').AsString) = '0') (* "0- Por conta do emitente" *)
            and
            ( QRecupVen_BASIC.FieldByName('FRETE').AsFloat > 0            )
            then
         begin
            // pareixFrete
            {
            ExibeMensagem
              (
                'Um erro de validaï¿½ï¿½o passou batido indevidamente na hora '      +
                'de gravar sua NF - MSG-03032016190934 : Quando o frete ï¿½ |'     +
                '"Por conta do emitente" , nï¿½o pode haver valor informado '      +
                'no campo FRETE, o mesmo tem que estar ZERADO. Favor corrigir '  +
                'esta NF e tentar novamente envia-la para SEFAZ.'                ,
                'ERRO VALIDAï¿½ï¿½O FRETE', Erro
              );
            fim;
            result := '';
            exit;
            }
         end;

         /////////////////////////////////////////////////////////////////////////////////////////////////

         nDelay                       := 1000;
         sId_UltimaNFe_EnviadaWORK1   := '';
         sId_UltimaNFe_EnviadaWORK1   := '';
         bMudouAutomParaConting       := false;
         bEnviar_NFe_Agora            := false;

         ////////////////////////////////////////////////////////////////////////////////////////////
         // Chamando a configuracao inicial do compo spdNFe
         ////////////////////////////////////////////////////////////////////////////////////////////

         // Marivaldo Santos - 07/12/2020
         TConfigNFE_ACBR.ConfigBasica(oACBRNFeGeral, MostraCampoString( 'CONFIG',
                                                      'SECAO_CAMPO',
                                                      'EMPRESA-CGC',
                                                      'CONTEUDO',
                                                      ' AND FILIAL = ' + intToStr(iCodigoFilial_NF))); // iCodigoFilial

         _nChave_Tabela_NF_Validando := QRecupVen_Basic.FieldByName('CHAVE_TABELA').AsInteger;
         TConfigNFE_ACBR.ConfiguraNF
         (
            oACBRNFeGeral,
            nil,
            IfThen(config('TXT','NOTA_FISCAL_CONSUMIDOR_ELETRONICA_CONTINGENCIA')='10', 'Contingencia', 'Normal'), 'WINCRYPT', 'NFE',
            MostraCampoString( 'CONFIG', 'SECAO_CAMPO', 'EMPRESA-CGC', 'CONTEUDO', ' AND FILIAL = ' + intToStr(iCodigoFilial_NF)),
            True,
            intToStr(iCodigoFilial_NF)
         );
         
         ////////////////////////////////////////////////////////////////////////////////////////////
         // Configurando DataSet
         ////////////////////////////////////////////////////////////////////////////////////////////

         Andamento_Envio('- Fazendo configurações iniciais do DataSet', '01112015121135');

         ////////////////////////////////////////////////////////////////////////////////////////////

         Cor_OLD := Lb_Aguarde_Linha_1.Color;
         _sTMP := Lb_Aguarde_Linha_1.Caption;

         Lb_Aguarde_Linha_1.Color   := clBtnFace; // Sem cor de fundo
         Lb_Aguarde_Linha_1.Caption := '';

         if(bVerificaModoEnvio)then
            Escolher_ModoOperacao_Envio_NFe();

         Lb_Aguarde_Linha_1.Color   := Cor_OLD;
         Lb_Aguarde_Linha_1.Caption := _sTMP;

         ///////////////////////// Inicio_Log - 1ï¿½ coisa a fazer /////////////////////////
         Cria_Pasta_Mais_Arq_LogsEnvio( MostraCampoString('VEN_BASIC', 'CHAVE_TABELA', Lb_CHAVE_TAB_ENVIANDO.Caption, 'NR_PED_ORC_OS','') );
         sArqLogEnvioNFe := _sLogEnvioNFe_So_Caminho + _sLogEnvioNFe_So_Arq;
         if FileExists(sArqLogEnvioNFe) then
            DeleteFile(sArqLogEnvioNFe);
         endif;

         LogEnviaNFe(sArqLogEnvioNFe, '28042015151722x', 'USUARIO_OPERADOR='     + IntToStr(iCodigoOperador)     );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151724x', 'USUARIO_AUTORIZADOR='  + IntToStr(_iCodigoAutorizador) );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151726x', 'IP_OPERADOR='          + GetIP()                       );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151728x', 'NOME_MAQUINA='         + Nome_Computador()             );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151730x', 'NOME_USUARIO_WINDOWS=' + Nome_Usuario_Windows()        );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151732x', 'FILIAL_LOGADA='        + IntToStr(iCodigoFilial)       );
         LogEnviaNFe(sArqLogEnvioNFe, '28042015151732x', 'FILIAL_NF='            + IntToStr(iCodigoFilial_NF)    );

         LogEnviaNFe(sArqLogEnvioNFe, '15040315010101a',
            'Inicio funcao G e r a r_Enviar_NFe_XM L() , ' +
            'NF Nr '     + MostraCampoString('VEN_BASIC','CHAVE_TABELA', Lb_CHAVE_TAB_ENVIANDO.Caption, 'NR_NF' ,'') + ' ' +
            'da filial ' + MostraCampoString('VEN_BASIC','CHAVE_TABELA', Lb_CHAVE_TAB_ENVIANDO.Caption, 'FILIAL',''));
         fim;
         ///////////////////////// ----------------------------- /////////////////////////

         sTodos_CodBar_Dif_13Dig := '';
         sTodos_GTIN13_Invalidos := '';
         sMensagemCompleta       := '';

         bUsarAuditorFiscal := False;

         sId_UltimaNFe_EnviadaWORK1 := '';
         sDiretXmlDestinat_NFeWORK1 := '';
         bMudouAutomParaConting     := false;
         OK                         := true;

         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         // Validando GTIN-13
         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

         LogEnviaNFe(sArqLogEnvioNFe, '15040220580101a','Vai iniciar validacao do GTIN MSG-201503280940-01');
         QRecupVen_Itens.First;
         
         while not QRecupVen_Itens.Eof do
         begin

            _sTMP1 := MostraCampoString('NAT_OPER', 'CODIGO_NATUREZA', TrocaVirgulaPorPonto(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString), 'OBS_LEGAL_PARA_NF', '');
            if (_sTMP1 <> '') and (pos(_sTMP1, sOBS_LEGAL_PARA_NF) <= 0) then
            begin
               sOBS_LEGAL_PARA_NF := sOBS_LEGAL_PARA_NF + '. ' + _sTMP1;
            end;

            sCodBarraItem := QRecupVen_Itens.FieldByName('CODIGO_BARRA').AsString;

            if length(sCodBarraItem) = 13 then
            begin

               if not GTIN13_Valido( AllTrim(sCodBarraItem) ) then
                  sTodos_GTIN13_Invalidos := sTodos_GTIN13_Invalidos + ' ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString;

            end
            else
            begin

               if Alltrim(sCodBarraItem) = '' then
                  sTodos_CodBar_Brancos    := sTodos_CodBar_Brancos   + ' ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString
               else
                  sTodos_CodBar_Dif_13Dig  := sTodos_CodBar_Dif_13Dig + ' ' + QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString;

            end;


            if ((Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) = '5933')or(Retorna_So_Numeros(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString) = '6933'))
               and
               ( QRecupVen_Itens.FieldByName('CODIGO_PRODUTO').AsString <> Config('TXT','PEDIDO-COD_PROD_REF_SERVICO_GARCON')  )
            then
               nQtde_CFOP_5933     := nQtde_CFOP_5933     + 1
            else
            begin
               nQtde_CFOP_DIF_5933 := nQtde_CFOP_DIF_5933 + 1;
            end;

            QRecupVen_Itens.Next;

         end;

         LogEnviaNFe(sArqLogEnvioNFe, '15040220580101b', 'Concluiu validacao do GTIN MSG-201503280940-02');

         LogEnviaNFe(sArqLogEnvioNFe, '15040221010101a', '');

         if sTodos_GTIN13_Invalidos <> '' then
            sMensagemCompleta := 'Erro nos Codigo de barras (GTIN13) dos seguintes itens : ' + sTodos_GTIN13_Invalidos + '.  ';

         if ( sTodos_CodBar_Dif_13Dig <> ''                      )
            and
            ( Config('TXT','NFE_NUNCA_ENVIAR_COD_BARRAS') <> 'S' )
            then
         begin
            sMensagemCompleta := sMensagemCompleta + 'Pode haver erro tambï¿½m nos Codigo de barras (diferentes de 13 dï¿½gitos) dos seguintes itens: ' +
            sTodos_CodBar_Dif_13Dig  + '.  ';
         end;

         if (
              (sTodos_GTIN13_Invalidos <> '')
              or
              (sTodos_CodBar_Dif_13Dig <> '') (*or (sTodos_CodBar_Brancos <> '')*)
            )
            and
            ( Config('TXT','NFE_NUNCA_ENVIAR_COD_BARRAS') <> 'S' )
            then
         begin
            sMensagemCompleta := sMensagemCompleta + '.  Deseja continuar a enviar a NFe assim mesmo ?';
            if ExibeMensagem(sMensagemCompleta, 'ERRO CÓDIGO DE BARRAS', Interrogacao) = mNao then
            begin
               // voltar o foco para a aplicacao pareixy-26/12/2013
               exit;
            end;
         end;
         LogEnviaNFe(sArqLogEnvioNFe, '15040221010101b', '');

         iNumeroTotDeItens := StrToInt(MostraCount('VEN_ITENS', 'CHAVE_TABELA',  'and CHAVE_TABELA = ' + Lb_CHAVE_TAB_ENVIANDO.Caption ) );

         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         // FIM - Validando GTIN-13
         ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

         //x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x
         /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         //
         // - INICIO Preenchimento da NFE
         //
         /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         //x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x/x

         oACBRNFeGeral.NotasFiscais.Clear;

         with oACBRNFeGeral.NotasFiscais.Add.NFe do
         begin

            sTpAmb_B24 := TpAmbToStr(Ide.tpAmb);

            //Dados de Identificacao da NFE
            DadosNFEACBR(oACBRNFeGeral);

            //Dados do Emitente
            DadosEmitenteACBR(oACBRNFeGeral, nQtde_CFOP_5933);

            //Dados do Destinatario
            DadosDestinatarioACBR(oACBRNFeGeral, sTpAmb_B24);

            //Dados do Item (Incluso Imposto e Informacoes adicionais
            DadosItemACBR(oACBRNFeGeral, sTpAmb_B24);

            //Dados dos Totais
            DadosTotaisACBR(oACBRNFeGeral);

            //Dados da Transportadora
            DadosTransportadoraACBR(oACBRNFeGeral);

            //Dados Informacoes Adicionais
            DadosInfoAdicionaisNFACBR(oACBRNFeGeral);

            //Dados das Faturas
            DadosFaturaACBR(oACBRNFeGeral);

            //Dados Exportacao
            DadosExportacaoACBR(oACBRNFeGeral);

            //Dados Pagamento
            DadosPagamentoACBR(oACBRNFeGeral);

            //Dados Responsavel Tecnico
            DadosRespTecACBR(oACBRNFeGeral);

            oACBRNFeGeral.NotasFiscais.GerarNFe;

         end;

      except on e:exception do

         //-----------------------------------------------------------------------------------------------------------------
         // Se nao tiver o try/Except, nao tem como ver erros/alertas basicos e importantes gerados pelo prï¿½prio componente,
         // como "Certificado vencido" e "outros", por isto todo metodo do componente tem que ter um Try/Except
         // mesmo que seja um try para um conjunto de comandos/metodos. Mas deve-se tomar cuidado para nao mostrar ao
         // usuario quando for erro de ACCESS VIOLATION muito comum do componente.
         //-----------------------------------------------------------------------------------------------------------------
         begin
            Result := '';
            if not AccessViolation(e.message) then
            begin

               Andamento_Envio('- Erro de exceção alimentando o DataSet', '12112015194040');
               Andamento_Envio(e.message                                , ''              );

               ExibeMensagem
                 (
                   e.message                                                  +'||'+

                   'MSG-11112015163424'                                       +'||'+

                   'OBS para suporte: Este erro ocorrido na função : '        +
                   'Alimenta_DataSet()'   ,
                   'ERRO ALIMENTANDO DATASET', Erro
                 );
               Fim;

               exit;
            end; (* End if *)

         end;  (* End Begin *)

      end;

   end;  (* End with Forms.... *)

   result := 'OK';  (* Se chegar ate aqui e por que gerou o DataSet com sucesso *)
   FGrupoIcmsUFDest.Free;

end;

function TF_NF110_Env_Alimenta_DataSet.DadosNFEACBR(oACBRNFe: TACBRNFe): Boolean;
var
   sTmp2, sTMP, sBase_CFOP, sCFOP: string;
   bOut: Boolean;
begin

   LogEnviaNFe(sArqLogEnvioNFe, '15040404000101a', 'Inicio with spdNFeDatasets1 do');
   
   with oACBRNFe.NotasFiscais[0].NFe do
   begin

      if (oACBRNFe.Configuracoes.Geral.FormaEmissao <> teNormal) then
      begin

         Ide.xJust := 'SERVIDORES DA UF EMISSORA OFF-LINE';
         Ide.dhCont := now;

      end;

      LogEnviaNFe(sArqLogEnvioNFe, '15040214430101a', 'Inicio Campo(' + QuotedStr('cUF_B02') + ').Value:=');
         Ide.cUF := UFtoCUF(Trim(MostraCampoString('config','SECAO_CAMPO','EMPRESA-UF', 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF))));//UFtoCUF(Trim(Config('TXT','EMPRESA-UF')));
      LogEnviaNFe(sArqLogEnvioNFe, '15040214430101b', 'Fim    Campo(' + QuotedStr('cUF_B02') + ').Value:=' + IntToStr(Ide.cUF));

      LogEnviaNFe(sArqLogEnvioNFe, '15040214440101a', 'Inicio Campo(' + QuotedStr('cNF_B03') + ').Value:=');
         Ide.cNF := GerarCodigoDFe(QRecupVen_Basic.FieldByName('NR_NF').AsInteger);
      LogEnviaNFe(sArqLogEnvioNFe, '15040214440101b', 'Fim    Campo(' + QuotedStr('cNF_B03') + ').Value:=' + IntToStr(Ide.cNF));

      LogEnviaNFe(sArqLogEnvioNFe, '15040214440101a', 'Inicio Campo(' + QuotedStr('natOp_B04') + ').Value:='        );
         sTmp2 := Trim(FormatFloat('000',QRecupVen_NF.FieldByName('NAT_OPERACAO').AsInteger));
         sTMP  := Trim(copy(MostraCampoString({'NAT_OPERACAO'}getTabelaNatOperacao(QRecupVen_Basic.FieldByName('DATA_EMISSAO').asDateTime),
                                              getCampoTabelaNatOperacao(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString), sTmp2, 'DESCRICAO' , ''),1,60));
         Ide.natOp := sTMP;
      LogEnviaNFe(sArqLogEnvioNFe, '15040214440101b', 'Fim    Campo(' + QuotedStr('natOp_B04') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040216190101a', 'Inicio Campo(' + QuotedStr('mod_B06') + ').Value:=');
         Ide.Modelo := 55;
      LogEnviaNFe(sArqLogEnvioNFe, '15040216190101b', 'Fim    Campo(' + QuotedStr('mod_B06') + ').Value:=55');

      LogEnviaNFe(sArqLogEnvioNFe, '15040216200101a', 'Inicio Campo(' + QuotedStr('serie_B07') + ').Value:=');
         sTMP := Retorna_So_Numeros(Trim(Config('TXT','Nota_Fiscal-SerieNF'))) ;
         Ide.serie := StrToInt(sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040216200101b', 'Fim    Campo(' + QuotedStr('serie_B07') + ').Value:=' + sTMP);

      LogEnviaNFe(sArqLogEnvioNFe, '15040216210101a', 'Inicio Ramdomize');
         Randomize;
      LogEnviaNFe(sArqLogEnvioNFe, '15040216210101b', 'Fim    Ramdomize');

      LogEnviaNFe(sArqLogEnvioNFe, '15040216220101a', 'Inicio Campo(' + QuotedStr('nNF_B08') + ').Value:='        );
         sTMP := IntToStr(StrToInt(Retorna_So_Numeros(Trim(IfThen(QRecupVen_Basic.FieldByName('NR_NF').AsString<>'', QRecupVen_Basic.FieldByName('NR_NF').AsString, '1')))));
         Ide.nNF := strToInt(sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040216220101b', 'Fim    Campo(' + QuotedStr('nNF_B08') + ').Value:=' + sTMP );

      //Pega o fuso horario aqui para nï¿½o precisar conectar no banco mais de uma vez
      //sFuso := GetFusoFromWeb(spdNFe1.UF);

      LogEnviaNFe(sArqLogEnvioNFe, '15040216230101a', 'Inicio Campo(' + QuotedStr('dhEmi_B09') + ').Value:='        );
         Ide.dEmi := StrToDateTime( FormatDateTime('DD/MM/YYYY', StrToDate(Trim(QRecupVen_Basic.FieldByName('DATA_EMISSAO').AsString))) +
                                    ' ' + FormatDateTime('HH:mm:ss', Now));
      LogEnviaNFe(sArqLogEnvioNFe, '15040216230101b', 'Fim    Campo(' + QuotedStr('dhEmi_B09') + ').Value:=' + DateToStr(now) );

      if Retorna_So_Numeros(QRecupVen_NF.FieldByName ('DATA_SAIDA').AsString) <> '' then
      begin

         LogEnviaNFe(sArqLogEnvioNFe, '15040216240101a', 'Inicio Campo(' + QuotedStr('dhSaiEnt_B10') + ').Value:=');
         if (Retorna_So_Numeros(QRecupVen_NF.FieldByName('HORA_SAIDA_ENTRADA').AsString) <> ''        )
         then
         begin

            sTMP :=
               FormatDateTime('DD/MM/YYYY', StrToDate(Trim(QRecupVen_NF.FieldByName('DATA_SAIDA').AsString))) + ' ' +
               FormatDateTime('HH:mm:ss', StrToTime(Trim(QRecupVen_NF.FieldByName('HORA_SAIDA_ENTRADA').AsString)));

            Ide.dSaiEnt := StrToDatetIME(sTMP);

         end
         else
         begin
            Ide.dSaiEnt := now;
         end;

         LogEnviaNFe(sArqLogEnvioNFe, '15040216240101b', 'Fim   Campo(' + QuotedStr('dhSaiEnt_B10') + ').Value:=' + DateToStr(Ide.dSaiEnt));
                
      end;

      LogEnviaNFe(sArqLogEnvioNFe, '15040216300101a', 'Fim   Campo(' + QuotedStr('tpNF_B11') + ').Value:='        );
         sTMP := TipoNF(Trim(QRecupVen_NF.FieldByName('OPERACAO').AsString));
         //Campo('tpNF_B11').Value := sTMP;
         Ide.tpNF := StrToTpNF(bOut, sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040216300101b', 'Fim   Campo(' + QuotedStr('tpNF_B11') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040219240101a', 'Inicio Campo(' + QuotedStr('idDest_B11a') + ').Value:='        );
         QRecupVen_Itens.First;
         sBase_CFOP := Copy(Retorna_So_Numeros( FormatFloat('#.000', QRecupVen_Itens.FieldByName('CFOP_ITENS').AsFloat) ), 1, 1);
         if      (sBase_CFOP='1') or (sBase_CFOP='5')   then
            sTMP := '1'  (* 1=Operacao interna       *)
         else if (sBase_CFOP='2') or (sBase_CFOP='6')   then
            sTMP := '2'  (* 2=Operacao interestadual *)
         else if (sBase_CFOP='3') or (sBase_CFOP='7')   then
            sTMP := '3'; (* 3=Operacao com exterior  *)

         Ide.idDest := StrToDestinoOperacao(bOut, sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040219240101b', 'Fim    Campo(' + QuotedStr('idDest_B11a') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040216400101a', 'Inicio Campo(' + QuotedStr('indFinal_B25a') + ').Value:='        );
         //sTMP := '1';
         sTMP := Trim(QRecupVen_NF.FieldByName('FINALIDADE_MERC_INDFINAL').AsString);
         if sTMP = 'REVENDA' then
           sTMP := '0'
         else
           sTMP := '1';
         Ide.indFinal := StrToConsumidorFinal(bOut, sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040216400101b', 'Fim    Campo(' + QuotedStr('indFinal_B25a') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040217020101a', 'Inicio Campo(' + QuotedStr('indPres_B25b') + ').Value:='        );
         sTMP := QRecupVen_NF.FieldByName('IND_PRESENCA').AsString;
         Ide.indPres := StrToPresencaComprador(bOut, sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040217020101b', 'Fim    Campo(' + QuotedStr('indPres_B25b') + ').Value:=' + sTMP );


      if ide.indPres in [pcInternet, pcTeleatendimento, pcEntregaDomicilio, pcOutros] then
      begin
         LogEnviaNFe(sArqLogEnvioNFe, '15040217020101a', 'Inicio Campo(' + QuotedStr('indIntermed_B25c') + ').Value:='        );
         sTMP := '0';
         Ide.indIntermed := StrToIndIntermed(bOut, sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217020101b', 'Fim    Campo(' + QuotedStr('indIntermed_B25c') + ').Value:=' + sTMP );
      end;

      LogEnviaNFe(sArqLogEnvioNFe, '15040216510101a', 'Inicio Campo(' + QuotedStr('cMunFG_B12') + ').Value:='        );
         sTMP := Trim(MostraCampoString('config','SECAO_CAMPO','EMPRESA-CIDADE-CODIGO','CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
         Ide.cMunFG := StrToInt(sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040216510101b', 'Fim    Campo(' + QuotedStr('cMunFG_B12') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040216520101a', 'Inicio Campo(' + QuotedStr('tpImp_B21') + ').Value:='        );
         sTMP := '1';
         Ide.tpImp := StrToTpImp(bOut, '1');
      LogEnviaNFe(sArqLogEnvioNFe, '15040216520101b', 'Fim    Campo(' + QuotedStr('tpImp_B21') + ').Value:=' + sTMP );

      Ide.tpEmis := oACBRNFe.Configuracoes.Geral.FormaEmissao;

      LogEnviaNFe(sArqLogEnvioNFe, '15040216530101a', 'Ini Campo(' + QuotedStr('cDV_B23') + ').Value:='        );
         Ide.cDV := 0;
      LogEnviaNFe(sArqLogEnvioNFe, '15040216530101b', 'Fim Campo(' + QuotedStr('cDV_B23') + ').Value:=0' );

      LogEnviaNFe(sArqLogEnvioNFe, '15040216560101a', 'Inicio Campo(' + QuotedStr('tpAmb_B24') + ').Value:='            );
         Ide.tpAmb := oACBRNFe.Configuracoes.WebServices.Ambiente;
      LogEnviaNFe(sArqLogEnvioNFe, '15040216560101b', 'Fim    Campo(' + QuotedStr('tpAmb_B24') + ').Value:=' + TpAmbToStr(Ide.tpAmb));

      LogEnviaNFe(sArqLogEnvioNFe, '15040216590101a', 'Inicio Campo(' + QuotedStr('finNFe_B25') + ').Value:='        );

      if trim(QRecupVen_NF.FieldByName('FINALIDADE').AsString) <> '' then
      begin
         if QRecupVen_NF.FieldByName('FINALIDADE').AsString = 'A' then
            sTMP := '1'
         else
         case QRecupVen_NF.FieldByName('FINALIDADE').AsInteger of
            1,5,6,7,8,9: sTMP := '1';
            4: sTMP := '4';
            2: sTMP := '2';
            3: sTMP := '3';
         end;
      end;

      Ide.finNFe := StrToFinNFe(bOut, sTMP);

      LogEnviaNFe(sArqLogEnvioNFe, '15040216590101b', 'Fim    Campo(' + QuotedStr('finNFe_B25') + ').Value:=' + sTMP );

      (* --- Informando chave de uma NF devolvida --- *)
      sCFOP := StringReplace(QRecupVen_Itens.FieldByName('CFOP_ITENS').AsString, ',', '', [rfReplaceAll,rfIgnoreCase] );

      if sCFOP = '5929' then
      begin
         if Trim(QRecupVen_NF.FieldByName('NR_ECF_REFERENC_NECF_BA22').AsString) <> '' then
         begin
            with Ide.NFref.Add do
            begin   
               LogEnviaNFe(sArqLogEnvioNFe, '05072016221947', 'Ini IncluirPart(' + QuotedStr('NRef') + ')' );
               LogEnviaNFe(sArqLogEnvioNFe, '05072016221954', 'Fim IncluirPart(' + QuotedStr('NRef') + ')' );

               RefECF.modelo := StrToECFModRef(bOut, '2D');

               sTMP := Trim(QRecupVen_NF.FieldByName('NR_ECF_REFERENC_NECF_BA22').AsString);
               LogEnviaNFe(sArqLogEnvioNFe, '05072016233735', ' Campo(' + QuotedStr('nECF_BA22') +').Value :='+sTMP);
               RefECF.nECF := sTMP;

               sTMP := Trim(QRecupVen_NF.FieldByName('COO_CUPFISC_REFERENC_NCOO_BA23').AsString);
               LogEnviaNFe(sArqLogEnvioNFe, '05072016233748', ' Campo(' + QuotedStr('nCOO_BA23') +').Value :='+sTMP);
               RefECF.nCOO := sTMP;
            end;
         end;   
      end
      else
      if QRecupVen_NF.FieldByName('TIPO_DOC_REFERENCIADO').AsString = 'ECF' then
      begin

         with Ide.NFref.Add do
         begin

            LogEnviaNFe(sArqLogEnvioNFe, '17022016161313a', 'Ini IncluirPart(' + QuotedStr('NRef') + ')' );
            LogEnviaNFe(sArqLogEnvioNFe, '17022016161313b', 'Fim IncluirPart(' + QuotedStr('NRef') + ')' );

            // NT2013.005_v1.22.pdf
            // "2B" = Cupom Fiscal emitido por mï¿½quina registradora (nï¿½o ECF);
            // "2C" = Cupom Fiscal PDV;
            // "2D" = Cupom Fiscal (emitido por ECF) (v2.0).
            LogEnviaNFe(sArqLogEnvioNFe, '17022016161314a', 'Ini Campo(' + QuotedStr('refNFe_Ba21') +').Value :=');
               sTMP := '2D';
               RefECF.modelo := StrToECFModRef(bOut, '2D');
            LogEnviaNFe(sArqLogEnvioNFe, '17022016161314b', 'Fim Campo(' + QuotedStr('refNFe_Ba21') +').Value :=');


            LogEnviaNFe(sArqLogEnvioNFe, '17022016162129a', 'Ini Campo(' + QuotedStr('refNFe_Ba22') +').Value :=');
               //Informar o nï¿½mero de ordem sequencial do ECF que emitiu o Cupom Fiscal vinculado ï¿½ NF-e (v2.0).
               //ex: se o contribuinte tem 2 ECF, entao um deles seria o nr 1 e o outro o nr 2
               sTMP := QRecupVen_NF.FieldByName('NR_ECF_REFERENC_NECF_BA22').AsString;
               RefECF.nECF := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '17022016162129b', 'Fim Campo(' + QuotedStr('refNFe_Ba22') +').Value :=');


            LogEnviaNFe(sArqLogEnvioNFe, '17022016162011a', 'ini Campo (' + QuotedStr('nCOO_BA23') +').Value :=');
               //Informar o Nï¿½mero do Contador de Ordem de Operacao - COO vinculado ï¿½ NF-e (v2.0).
               //Veja campo (impresso no cupom) denominado COO
               sTMP := QRecupVen_NF.FieldByName('COO_CUPFISC_REFERENC_NCOO_BA23').AsString;
               RefECF.nCOO := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '17022016162011b', 'Fim SalvarPart(' + QuotedStr('NRef') + ')' );

         end;

      end;

      if Contido( Trim(QRecupVen_NF.FieldByName('FINALIDADE').AsString) , '|2|4|' )then
      begin

         with Ide.NFref.Add do
         begin

            LogEnviaNFe(sArqLogEnvioNFe, '15040819230101a', 'Inicio Campo(' + QuotedStr('refNFe_Ba02') +').Value :=');
               sTMP := QRecupVen_NF.FieldByName('CHAVE_NF_REFERENCIADA').AsString;
               refNFe := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040819230101b', 'Fim    Campo(' + QuotedStr('refNFe_Ba02') +').Value :=');

         end;
         
      end;

      (* -------------------------------------------- *)

      LogEnviaNFe(sArqLogEnvioNFe, '15040217000101a', 'Inicio Campo(' + QuotedStr('procEmi_B26') + ').Value:='        );
         sTMP := '0';
         Ide.procEmi := StrToprocEmi(bOut, sTMP);
      LogEnviaNFe(sArqLogEnvioNFe, '15040217000101b', 'Fim    Campo(' + QuotedStr('procEmi_B26') + ').Value:=' + sTMP );

      LogEnviaNFe(sArqLogEnvioNFe, '15040217020101a', 'Inicio Campo(' + QuotedStr('verProc_B27') + ').Value:='        );
         sTMP := _sLiberacaoAplic;
         Ide.verProc := sTMP;
      LogEnviaNFe(sArqLogEnvioNFe, '15040217020101b', 'Fim    Campo(' + QuotedStr('verProc_B27') + ').Value:=' + sTMP );

      //===================================================================================================================
      //Adicionado em 26/10/2019 por Nilton Diniz, para cliente da Bahia
      //Campos referentes ao escritorio de contabilidade da empresa
      sTMP :=
         StringReplace(
         StringReplace(
         StringReplace(ConfigSemErro('TXT','NOTA_FISCAL_CNPJ_CONTABILIDADE'), '.', '', [rfReplaceAll]),
         '-', '', [rfReplaceAll]),
         '/', '', [rfReplaceAll]);
      fim;
             
      if(sTMP <> '')then
      begin

         with autXML.Add do
         begin

            CNPJCPF := sTMP;
            
         end;

      end;

   end;

end;

function TF_NF110_Env_Alimenta_DataSet.DadosEmitenteACBR(oACBRNFe: TACBRNFe; nQtde_CFOP_5933: Integer): Boolean;
var
   sTMP: String;
   bOut: Boolean;
begin

   try

      with oACBRNFe.NotasFiscais[0].NFe.Emit do
      begin

         LogEnviaNFe(sArqLogEnvioNFe, '15040217020101a', 'Inicio Campo(' + QuotedStr('CNPJ_C02') + ').Value:='        );
            sTMP := RetiraCaractere(MostraCampoString('config','SECAO_CAMPO','EMPRESA-CGC'           , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            CNPJCPF := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217020101b', 'Fim    Campo(' + QuotedStr('CNPJ_C02') + ').Value:=' + sTMP );

         //Isso ï¿½ do emitente
         if nQtde_CFOP_5933 > 0 then
         begin

            if Config('TXT','EMPRESA-INSC_MUNICIPAL') <> '' then
               sTMP := Config('TXT','EMPRESA-INSC_MUNICIPAL')
            else begin
               sTMP := 'ISENTO';
            end;

            IM := sTMP;

         end;

         LogEnviaNFe(sArqLogEnvioNFe, '15040217030101a', 'Inicio Campo(' + QuotedStr('xNome_C03') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-NOME'          , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            xNome := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217030101b', 'Fim    Campo(' + QuotedStr('xNome_C03') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217040101a', 'Inicio Campo(' + QuotedStr('xFant_C04') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-NOME_FANTASIA' , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            xFant := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217040101b', 'Fim    Campo(' + QuotedStr('xFant_C04') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217050101a', 'Inicio Campo(' + QuotedStr('xLgr_C06') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-ENDERECO'      , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.xLgr := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217050101b', 'Fim    Campo(' + QuotedStr('xLgr_C06') + ').Value:='  + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217060101a', 'Inicio Campo(' + QuotedStr('nro_C07') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-NUMERO'        , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.nro := IfThen(sTMP = '', '0', sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217060101b', 'Fim    Campo(' + QuotedStr('nro_C07') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217070101a', 'Inicio Campo(' + QuotedStr('xCpl_c08') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-COMPLEMENTO'   , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.xCpl := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217070101b', 'Fim    Campo(' + QuotedStr('xCpl_c08') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217080101a', 'Inicio Campo(' + QuotedStr('xBairro_C09') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-BAIRRO'        , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.xBairro := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217080101b', 'Fim    Campo(' + QuotedStr('xBairro_C09') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217090101a', 'Inicio Campo(' + QuotedStr('cMun_C10') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-CIDADE-CODIGO' , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.cMun := StrToInt(sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217090101b', 'Fim    Campo(' + QuotedStr('cMun_C10') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217100101a', 'Inicio Campo(' + QuotedStr('xMun_C11') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-CIDADE'        , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.xMun := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217100101b', 'Fim    Campo(' + QuotedStr('xMun_C11') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217110101a', 'Inicio Campo(' + QuotedStr('UF_C12') + ').Value:='        );
            sTMP := Trim(MostraCampoString                ('config','SECAO_CAMPO','EMPRESA-UF'            , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.UF := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217110101b', 'Fim    Campo(' + QuotedStr('UF_C12') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217120101a', 'Inicio Campo(' + QuotedStr('CEP_C13') + ').Value:='        );
            sTMP := Retorna_So_Numeros(MostraCampoNumerico('config','SECAO_CAMPO','EMPRESA-CEP'           , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.CEP := StrToInt(sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217120101b', 'Fim    Campo(' + QuotedStr('CEP_C13') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217130101a', 'Inicio Campo(' + QuotedStr('cPais_C14') + ').Value:='        );
            sTMP := '1058';
            EnderEmit.cPais := StrToInt(sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217130101b', 'Fim    Campo(' + QuotedStr('cPais_C14') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217140101a', 'Inicio Campo(' + QuotedStr('xPais_C15') + ').Value:='        );
            sTMP := 'BRASIL';
            EnderEmit.xPais := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217140101b', 'Fim    Campo(' + QuotedStr('xPais_C15') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217150101a', 'Inicio Campo(' + QuotedStr('fone_C16') + ').Value:='        );
            sTMP := Retorna_So_Numeros(MostraCampoString  ('config','SECAO_CAMPO','EMPRESA-TELEFONE1'     , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            EnderEmit.fone := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217150101b', 'Fim    Campo(' + QuotedStr('fone_C16') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217160101a', 'Inicio Campo(' + QuotedStr('IE_C17') + ').Value:='        );
            sTMP := Retorna_So_Numeros(MostraCampoString  ('config','SECAO_CAMPO','EMPRESA-INSC_ESTADUAL' , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            IE := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217160101b', 'Fim    Campo(' + QuotedStr('IE_C17') + ').Value:=' + sTMP );

         //LogEnviaNFe(sArqLogEnvioNFe, '15040217170101a', 'Inicio Campo(' + QuotedStr('IEST_C18') + ').Value:='        );
         //   sTMP := '';
            //Campo('IEST_C18').Value    := sTMP;
         //LogEnviaNFe(sArqLogEnvioNFe, '15040217170101b', 'Fim    Campo(' + QuotedStr('IEST_C18') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040217180101a', 'Inicio Campo(' + QuotedStr('CRT_C21') + ').Value:='        );
            sTMP := Trim(QRecupVen_NF.FieldByName('CRT').AsString);
            CRT := StrToCRT(bOut, sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040217180101b', 'Fim    Campo(' + QuotedStr('CRT_C21') + ').Value:=' + sTMP );

         //Inscrição Municipal
         LogEnviaNFe(sArqLogEnvioNFe, '15040217180101a', 'Inicio Campo(' + QuotedStr('IM_C19') + ').Value:='        );
            sTMP := Retorna_So_Numeros(MostraCampoString('config','SECAO_CAMPO','EMPRESA-INSC_MUNICIPAL' , 'CONTEUDO', 'and FILIAL = ' + IntToStr(iCodigoFilial_NF)));
            if Trim(sTMP) <> '' then
               IM := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040217180101b', 'Fim    Campo(' + QuotedStr('IM_C19') + ').Value:=' + sTMP );

         if (CNPJCPF = ''           ) or
            (xNome = ''             ) or
            (xFant = ''             ) or
            (EnderEmit.xLgr = ''    ) or
            (EnderEmit.nro = ''     ) or
            (EnderEmit.xBairro = '' ) or
            (EnderEmit.cMun = 0     ) or
            (EnderEmit.xMun = ''    ) or
            (EnderEmit.UF = ''      ) or
            (EnderEmit.CEP = 0      ) or
            (EnderEmit.cPais = 0    ) or
            (EnderEmit.xPais = ''   ) then
         begin
            ExibeMensagem('Erro! Dados do emitente da NFe estão incompletos. '   +
            'Veja configuração do sistema Guia Empresa. Veja também Log_NFe.txt',
            'DADOS DO EMITENTE', Erro);
            exit;
         end;

         Result := True;

      end;

   except

      on error: Exception do
      begin
         Raise;
         Result := False;
      end;

   end;

end;

function TF_NF110_Env_Alimenta_DataSet.DadosDestinatarioACBR(oACBRNFe: TACBRNFe; sTpAmb_B24: String): Boolean;
var
   bOut: Boolean;
   sTMP, sNomeCli_SeHomologa: String;
begin

   try

      with oACBRNFe.NotasFiscais[0].NFe.Dest do
      begin

         sNomeCli_SeHomologa := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL';

         if QRecupVen_NF.FieldByName('ESTADO_CLI').AsString <> 'EX' then  // (EX = Exterior)
         begin

            LogEnviaNFe(sArqLogEnvioNFe, '15040218320101a', 'Inicio Campo(' + QuotedStr('CNPJ_E02') + ').Value:='        );
               sTMP := Retorna_So_Numeros(QRecupVen_NF.FieldByName('CGC_CPF').AsString);
               CNPJCPF := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218320101b', 'Fim    Campo(' + QuotedStr('CNPJ_E02') + ').Value:=' + sTMP );

            if sTpAmb_B24  = '1' then // 1=Producao
            begin

               LogEnviaNFe(sArqLogEnvioNFe, '15040218340101a', 'Inicio Campo(' + QuotedStr('xNome_E04') + ').Value:='        );
                  sTMP := Trim(QRecupVen_NF.FieldByName('NOME_CLI').AsString);
                  xNome := sTMP;
               LogEnviaNFe(sArqLogEnvioNFe, '15040218340101b', 'Fim    Campo(' + QuotedStr('xNome_E04') + ').Value:=' + sTMP );

            end
            else                     // 2=Homologacao
            begin

               LogEnviaNFe(sArqLogEnvioNFe, '15040218370101a', 'Inicio Campo(' + QuotedStr('xNome_E04') + ').Value:='        );
                  sTMP := Trim(sNomeCli_SeHomologa);
                  xNome := sTMP;
               LogEnviaNFe(sArqLogEnvioNFe, '15040218370101b', 'Fim    Campo(' + QuotedStr('xNome_E04') + ').Value:=' + sTMP );

            end;

         end
         else  (* NF de exportacao *)
         begin
            (* Para NF de EXPORTACAO, informar CNPJ/CPF vazio tanto para PRODUCAO como HOMOLOGACAO *)

            LogEnviaNFe(sArqLogEnvioNFe, '15040218390101a', 'Inicio Campo(' + QuotedStr('CNPJ_E02') + ').Value:='        );
               sTMP := '';
               CNPJCPF := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218390101b', 'Fim    Campo(' + QuotedStr('CNPJ_E02') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040218410101a', 'Inicio Campo(' + QuotedStr('xNome_E04') + ').Value:='        );

            if sTpAmb_B24  = '1' then // 1=Producao
               sTMP := Trim(QRecupVen_NF.FieldByName('NOME_CLI').AsString)
            else
               sTMP := Trim(sNomeCli_SeHomologa);

            xNome := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218410101b', 'Fim    Campo(' + QuotedStr('xNome_E04') + ').Value:=' + sTMP );

         end;

         with EnderDest do
         begin

            LogEnviaNFe(sArqLogEnvioNFe, '15040218420101a', 'Inicio Campo(' + QuotedStr('xLgr_E06') + ').Value:='        );
               sTMP := Trim(QRecupVen_NF.FieldByName('ENDERECO_CLI').AsString);
               xLgr := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218420101b', 'Fim    Campo(' + QuotedStr('xLgr_E06') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040218520101a', 'Inicio Campo(' + QuotedStr('nro_E07') + ').Value:='        );
               sTMP := Trim(QRecupVen_NF.FieldByName('NUMERO_ENDERECO').AsString);
               nro := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218520101b', 'Fim    Campo(' + QuotedStr('nro_E07') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040218530101a', 'Inicio Campo(' + QuotedStr('xCpl_E08') + ').Value:='        );
               sTMP := Trim(QRecupVen_NF.FieldByName('COMPLEMENTO').AsString);
               xCpl := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218530101b', 'Fim    Campo(' + QuotedStr('xCpl_E08') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040218540101a', 'Inicio Campo(' + QuotedStr('xBairro_E09') + ').Value:='        );
               sTMP := Trim(QRecupVen_NF.FieldByName('BAIRRO_CLI'     ).AsString);
               xBairro := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218540101b', 'Inicio Campo(' + QuotedStr('xBairro_E09') + ').Value:=' + sTMP );

            if QRecupVen_NF.FieldByName('ESTADO_CLI').AsString <> 'EX' then
            begin
               LogEnviaNFe(sArqLogEnvioNFe, '15040218550101a', 'Inicio Campo(' + QuotedStr('cMun_E10') + ').Value:='        );
                  sTMP := Trim(QRecupVen_NF.FieldByName('CODIGO_CIDADE').AsString);
                  cMun := StrToInt(sTMP);
               LogEnviaNFe(sArqLogEnvioNFe, '15040218550101b', 'Fim    Campo(' + QuotedStr('cMun_E10') + ').Value:=' + sTMP );

               LogEnviaNFe(sArqLogEnvioNFe, '15040218560101a', 'Inicio Campo(' + QuotedStr('xMun_E11') + ').Value:='        );
                  sTMP := Trim(QRecupVen_NF.FieldByName('CIDADE_CLI').AsString);
                  xMun := sTMP;
               LogEnviaNFe(sArqLogEnvioNFe, '15040218560101b', 'Fim    Campo(' + QuotedStr('xMun_E11') + ').Value:=' + sTMP );
            end
            else
            begin
               LogEnviaNFe(sArqLogEnvioNFe, '15040218570101a', 'Inicio Campo(' + QuotedStr('cMun_E10') + ').Value:='        );
                  sTMP := '9999999';
                  cMun := StrToInt(sTMP);
               LogEnviaNFe(sArqLogEnvioNFe, '15040218570101b', 'Fim    Campo(' + QuotedStr('cMun_E10') + ').Value:=' + sTMP );

               LogEnviaNFe(sArqLogEnvioNFe, '15040218580101a', 'Inicio Campo(' + QuotedStr('xMun_E11') + ').Value:='        );
                  sTMP := 'EXTERIOR';
                  xMun := sTMP;
               LogEnviaNFe(sArqLogEnvioNFe, '15040218580101b', 'Fim    Campo(' + QuotedStr('xMun_E11') + ').Value:=' + sTMP );
            end;

            LogEnviaNFe(sArqLogEnvioNFe, '15040218590101a', 'Inicio Campo(' + QuotedStr('UF_E12') + ').Value:='        );
               sTMP := Trim(QRecupVen_NF.FieldByName('ESTADO_CLI').AsString);
               UF := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040218590101b', 'Fim    Campo(' + QuotedStr('UF_E12') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040219000101a', 'Inicio Campo(' + QuotedStr('ESTADO_CLI') + ').Value:='        );

            if QRecupVen_NF.FieldByName('ESTADO_CLI').AsString <> 'EX' then
            begin
               sTMP := Retorna_So_Numeros(QRecupVen_NF.FieldByName('CEP_CLI'    ).AsString);
               CEP := StrToInt(sTMP);
            end
            else
            begin
               sTMP := '';
               CEP := 0;
            end;

            LogEnviaNFe(sArqLogEnvioNFe, '15040219000101b', 'Fim    Campo(' + QuotedStr('ESTADO_CLI') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040219020101a', 'Inicio Campo(' + QuotedStr('cPais_E14') + ').Value:='        );
               sTMP := StrZeroEsquerda   (IntToStr(QRecupVen_NF.FieldByName('CODIGO_PAIS').AsInteger),4);
               cPais := StrToInt(sTMP);
            LogEnviaNFe(sArqLogEnvioNFe, '15040219020101b', 'Fim    Campo(' + QuotedStr('cPais_E14') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040219030101a', 'Inicio Campo(' + QuotedStr('xPais_E15') + ').Value:='        );
               sTMP := Trim(Retorna_Nome_Pais (QRecupVen_NF.FieldByName('CODIGO_PAIS').AsInteger));
               xPais := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040219030101b', 'Fim    Campo(' + QuotedStr('xPais_E15') + ').Value:=' + sTMP );

            LogEnviaNFe(sArqLogEnvioNFe, '15040219040101a', 'Inicio Campo(' + QuotedStr('fone_E16') + ').Value:='        );
               sTMP := Retorna_So_Numeros(QRecupVen_NF.FieldByName('FONE_FAX').AsString);
               fone := sTMP;
            LogEnviaNFe(sArqLogEnvioNFe, '15040219040101b', 'Fim    Campo(' + QuotedStr('fone_E16') + ').Value:=' + sTMP );

         end;

         LogEnviaNFe(sArqLogEnvioNFe, '15040219050101a', 'Inicio Campo(' + QuotedStr('indIEDest_E16a') + ').Value:='        );
            sTMP := QRecupVen_NF.FieldByName('INDICADOR_IE').AsString;
            indIEDest := StrToindIEDest(bOut, sTMP);
         LogEnviaNFe(sArqLogEnvioNFe, '15040219050101b', 'Fim    Campo(' + QuotedStr('indIEDest_E16a') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040219070101a', 'Inicio Campo(' + QuotedStr('IE_E17') + ').Value:=' );
            if QRecupVen_NF.FieldByName('ESTADO_CLI').AsString <> 'EX' then
            begin

               if(indIEDestToStr(indIEDest) = '1')and(Retorna_So_Numeros(QRecupVen_NF.FieldByName('INSC_EST_RG').AsString) <> '')then
               begin

                  sTMP := Retorna_So_Numeros(QRecupVen_NF.FieldByName('INSC_EST_RG').AsString)

               end
               else
               begin
                  //Setando cliente como isento
                  sTMP := QRecupVen_NF.FieldByName('INDICADOR_IE').AsString;
                  indIEDest := StrToindIEDest(bOut, sTMP);
                  sTMP := '';
               end;

               //Tratamento para quando vem ISENTO do cadastro
               if QRecupVen_NF.FieldByName('INSC_EST_RG').AsString = 'ISENTO' then
               begin
                  sTMP := '';//atribuído IE abaixo
                  indIEDest := StrToindIEDest(bOut, '2');
               end;

               IE := sTMP;

            end
            else
            begin
               sTMP := '';
               IE := sTMP;
            end;
         LogEnviaNFe(sArqLogEnvioNFe, '15040219070101b', 'Fim    Campo(' + QuotedStr('IE_E17') + ').Value:=' + sTMP );

         LogEnviaNFe(sArqLogEnvioNFe, '15040219090101a', 'Inicio Campo(' + QuotedStr('ISUF_E18') + ').Value:=' );
            sTMP := '';
            ISUF := sTMP;
         LogEnviaNFe(sArqLogEnvioNFe, '15040219090101b', 'Fim    Campo(' + QuotedStr('ISUF_E18') + ').Value:=' + sTMP);


      end;

   except

      raise;
      Result := False;

   end;

end;
function TF_NF110_Env_Alimenta_DataSet.CalculaTotaisIPIDevol(oACBRNFe: TACBRNFe): Double;
var
   nTotalItens: Integer;
   i: Integer;
   nValorIPI: Double;
begin

   nTotalItens := oACBRNFe.NotasFiscais[0].NFe.Det.Count;
   nValorIPI := 0;

   for i:= 0 to nTotalItens -1 do
   begin

      nValorIPI := nValorIPI + oACBRNFe.NotasFiscais[0].NFe.Det.Items[i].vIPIDevol;

   end;

   Result := nValorIPI;

end;

end.


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// "ID-Coment-06/03/2025-17:53-Mateus"
// Alteracao feita por mateus em 06/03/2025, a pedido do cliente APOLLO INDUSTRIA E COMERCIO DE LIXAS LTDA,
// e seu contador Renato nosso parceiro.
//
// Nao ha duvida de que este novo calculo esta correto, so nao foi percebido antes pois nunca havia concidido de
// algum cliente ter redução de base de calculo e tambem IPI na mesma NF.
//
// Linha Original (subtrai erroneamente o VR DO IPI da BC DO ICMS):
//   nVr_a_Reduzir_de_ICMS_Item := (nVr_Tot_Com_Desconto_Item + nVrIpiRateado_Ou_Zerado + nFreteRateado) * (StrToFloat(sPercent_Reduc_BC)/100);
// Nova Linha:
//   nVr_a_Reduzir_de_ICMS_Item := (nVr_Tot_Com_Desconto_Item ) * (StrToFloat(sPercent_Reduc_BC)/100);
//
// Conclusao logica: O valor do IPI nem do FRETE, nao deve influenciar em nada na BC DO ICMS, nao deve ser subtraido
// nem somado à BC DO ICMS. O IPI é um calculo a parte
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

